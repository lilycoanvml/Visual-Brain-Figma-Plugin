<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      padding: 16px; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      font-size: 12px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: -16px -16px 16px -16px;
      padding: 20px 16px;
      color: white;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .header p {
      margin: 4px 0 0 0;
      font-size: 11px;
      opacity: 0.9;
    }
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      position: relative;
      transition: color 0.2s;
    }
    .tab.active {
      color: #667eea;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #667eea;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h3 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .button {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .button:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    .button:active {
      transform: translateY(0);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 11px;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      display: none;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border-left: 3px solid #28a745;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 3px solid #dc3545;
    }
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 3px solid #17a2b8;
    }
    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .file-upload:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .file-upload.dragover {
      border-color: #667eea;
      background: #f0f2ff;
      border-style: solid;
    }
    .file-upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    .file-upload-text {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }
    .file-upload-subtext {
      font-size: 11px;
      color: #999;
    }
    .uploaded-file {
      background: #f0f2ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .uploaded-file-icon {
      font-size: 24px;
    }
    .uploaded-file-info {
      flex: 1;
    }
    .uploaded-file-name {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }
    .uploaded-file-size {
      font-size: 10px;
      color: #666;
    }
    .uploaded-file-remove {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .analysis-result {
      margin-top: 16px;
    }
    .analysis-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .analysis-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .violations-list, .good-list, .suggestions-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .violations-list li, .good-list li, .suggestions-list li {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.5;
    }
    .violations-list li {
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .violations-list li.high {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    .good-list li {
      background: #d4edda;
      border-left: 3px solid #28a745;
    }
    .suggestions-list li {
      background: #d1ecf1;
      border-left: 3px solid #17a2b8;
    }
    .severity-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 6px;
    }
    .severity-high {
      background: #dc3545;
      color: white;
    }
    .severity-medium {
      background: #ffc107;
      color: #000;
    }
    .severity-low {
      background: #17a2b8;
      color: white;
    }
    .guidelines-preview {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .guidelines-preview h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #333;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #file-input {
      display: none;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }
    .checkbox-group {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #333;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .checkbox-label:last-child {
      margin-bottom: 0;
    }
    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .stat-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® Brand Guidelines Checker</h1>
    <p>Upload guidelines and analyze Figma selections</p>
  </div>

  <div id="message"></div>

  <div class="tab-container">
    <button class="tab active" data-tab="upload">Upload Guidelines</button>
    <button class="tab" data-tab="analyze">Analyze Selection</button>
  </div>

  <!-- Upload Tab -->
  <div id="upload-tab" class="tab-content active">
    <div class="section">
      <h3>Upload Brand Guidelines Document</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Upload a TXT or PDF file containing your brand guidelines. The plugin will parse colors, fonts, spacing, images, and layouts.
      </p>

      <input type="file" id="file-input" accept=".txt,.pdf">
      
      <div class="file-upload" id="drop-zone">
        <div class="file-upload-icon">üìÅ</div>
        <div class="file-upload-text">Drop your guidelines here</div>
        <div class="file-upload-subtext">Supports TXT and PDF (max 50MB)</div>
      </div>

      <div id="uploaded-file-display"></div>

      <div class="checkbox-group" id="parse-options">
        <label class="checkbox-label">
          <input type="checkbox" id="deep-analysis" checked>
          <span>üîç Deep Analysis (Extract images, colors from PDF pages)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ocr-analysis">
          <span>üì∑ OCR Analysis (Extract text from images - slower)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ai-analysis" checked>
          <span>ü§ñ AI Analysis (Understand brand voice, tone, and visual style)</span>
        </label>
      </div>

      <div id="api-key-section" style="margin-top: 12px; display: none;">
        <label style="display: block; font-size: 11px; font-weight: 500; color: #666; margin-bottom: 4px;">
          Anthropic API Key (Optional - for AI analysis)
        </label>
        <input type="password" id="api-key-input" placeholder="sk-ant-..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
        <p style="font-size: 9px; color: #999; margin: 4px 0 0 0;">
          Get your API key at <a href="https://console.anthropic.com" target="_blank" style="color: #667eea;">console.anthropic.com</a>
        </p>
      </div>

      <div id="parse-progress" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">Processing...</div>
      </div>

      <button class="button" id="parse-button" disabled>
        üîç Parse Guidelines
      </button>
    </div>

    <div id="guidelines-preview-section" style="display: none;">
      <div class="section">
        <h3>Parsed Guidelines</h3>
        <div class="guidelines-preview" id="guidelines-preview-content"></div>
      </div>
    </div>
  </div>

  <!-- Analyze Tab -->
  <div id="analyze-tab" class="tab-content">
    <!-- AI Chat Section - Now at the top -->
    <div class="section" id="ai-chat-section">
      <h3>üí¨ AI Brand Assistant</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        <span id="chat-status-text">Upload brand guidelines with AI analysis to start chatting...</span>
      </p>
      
      <div id="chat-messages" style="background: #f8f9fa; border-radius: 8px; padding: 12px; min-height: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 12px;">
        <div id="chat-welcome" style="text-align: center; color: #999; font-size: 11px; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 12px;">ü§ñ</div>
          <p style="margin: 0 0 8px 0;"><strong>AI Brand Assistant Ready</strong></p>
          <p style="margin: 0;">Upload your brand guidelines with AI analysis enabled, then come back here to:</p>
          <ul style="list-style: none; padding: 0; margin: 12px 0 0 0;">
            <li>‚úÖ Validate your guidelines</li>
            <li>üí° Get improvement suggestions</li>
            <li>üé® Explore design ideas</li>
            <li>üéØ Understand your brand better</li>
            <li>üìê Check Figma designs</li>
          </ul>
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <input 
          type="text" 
          id="chat-input" 
          placeholder="Ask about your brand, guidelines, or get design feedback..."
          style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;"
          onkeypress="if(event.key === 'Enter') sendChatMessage()"
          disabled
        >
        <button class="button" onclick="sendChatMessage()" id="send-chat-btn" style="width: auto; padding: 10px 20px;" disabled>
          Send
        </button>
      </div>

      <div id="quick-questions" style="margin-bottom: 16px; display: none;">
        <p style="font-size: 10px; color: #666; margin: 0 0 6px 0; font-weight: 500;">Quick questions:</p>
        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
          <button class="button secondary" onclick="askQuickQuestion('Summarize my brand guidelines')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üìã Summarize guidelines
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What is my brand personality and target audience?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üéØ Brand overview
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What colors and fonts should I use?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üé® Design specs
          </button>
          <button class="button secondary" onclick="askQuickQuestion('Give me 3 design ideas that match my brand')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üí° Design ideas
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What are the dos and donts of my brand?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            ‚ö†Ô∏è Dos & Don'ts
          </button>
        </div>
      </div>
    </div>

    <!-- Figma Analysis Section - Moved below chat -->
    <div class="section">
      <h3>üîç Analyze Figma Selection</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Select elements in Figma to check them against your brand guidelines. The AI will analyze them and you can discuss the results in the chat above.
      </p>
      <button class="button" id="analyze-button">üîç Analyze Selected Elements</button>
      <p style="font-size: 10px; color: #999; margin-top: 8px; text-align: center;">
        Tip: Select multiple elements for a section overview
      </p>
    </div>

    <div id="analysis-results"></div>
  </div>

  <script>
    // Set PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    let uploadedFile = null;
    let uploadedFileContent = null;
    let parsedGuidelines = null;
    let pdfImages = [];
    let chatHistory = [];
    let currentAnalysisData = null;

    // Initialize
    window.onload = () => {
      setupDragAndDrop();
      setupTabs();
      setupButtons();
      setupAPIKeySection();
      parent.postMessage({ pluginMessage: { type: 'load-guidelines' } }, '*');
    };

    function setupAPIKeySection() {
      const aiCheckbox = document.getElementById('ai-analysis');
      const apiKeySection = document.getElementById('api-key-section');
      
      aiCheckbox.addEventListener('change', (e) => {
        apiKeySection.style.display = e.target.checked ? 'block' : 'none';
      });
      
      // Request saved API key from Figma storage
      parent.postMessage({ pluginMessage: { type: 'load-api-key' } }, '*');
      
      // Show section if AI analysis is checked
      if (aiCheckbox.checked) {
        apiKeySection.style.display = 'block';
      }
    }

    // Handle messages from Figma plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'guidelines-loaded') {
        if (msg.guidelines) {
          parsedGuidelines = msg.guidelines;
          displayGuidelinesPreview(msg.guidelines);
          
          // Enable chat if AI understanding is available
          if (msg.guidelines.aiUnderstanding) {
            enableChat();
          }
        }
      }
      
      if (msg.type === 'api-key-loaded') {
        if (msg.apiKey) {
          document.getElementById('api-key-input').value = msg.apiKey;
        }
      }
      
      if (msg.type === 'parse-success') {
        parsedGuidelines = msg.guidelines;
        displayGuidelinesPreview(msg.guidelines);
        showMessage('Guidelines parsed and saved successfully!', 'success');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        
        // Enable chat if AI understanding is available
        if (msg.guidelines.aiUnderstanding) {
          enableChat();
          showMessage('AI Brand Assistant is now ready! Go to the Analyze tab to chat.', 'success');
        }
      }
      
      if (msg.type === 'analysis-complete') {
        currentAnalysisData = msg.analysis;
        displayAnalysis(msg.analysis);
        
        // Add analysis summary to chat
        if (parsedGuidelines && parsedGuidelines.aiUnderstanding) {
          const summary = `üìä Analysis complete for "${msg.analysis.name}". Found ${msg.analysis.violations.length} issues and ${msg.analysis.goodPractices.length} good practices. Feel free to ask me about the results!`;
          addChatMessage('system', summary);
        }
      }
      
      if (msg.type === 'error') {
        showMessage(msg.message, 'error');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
      }
    };

    // Setup tab switching
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // Setup button listeners
    function setupButtons() {
      document.getElementById('parse-button').addEventListener('click', parseGuidelines);
      document.getElementById('analyze-button').addEventListener('click', analyzeSelection);
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('drop-zone').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
    }

    // Drag and drop setup
    function setupDragAndDrop() {
      const dropZone = document.getElementById('drop-zone');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('dragover');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('dragover');
        }, false);
      });

      dropZone.addEventListener('drop', handleDrop, false);
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    async function handleFile(file) {
      const maxSize = 50 * 1024 * 1024; // 50MB
      const allowedTypes = ['.txt', '.pdf'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedTypes.includes(fileExt)) {
        showMessage('Invalid file type. Please upload TXT or PDF files.', 'error');
        return;
      }

      if (file.size > maxSize) {
        showMessage('File is too large. Maximum size is 50MB.', 'error');
        return;
      }

      uploadedFile = file;
      showMessage('Processing file...', 'info');

      try {
        if (fileExt === '.pdf') {
          uploadedFileContent = await extractTextFromPDF(file);
          if (!uploadedFileContent || uploadedFileContent.trim().length === 0) {
            showMessage('Could not extract text from PDF. The PDF might be image-based or empty.', 'error');
            uploadedFile = null;
            uploadedFileContent = null;
            return;
          }
        } else {
          uploadedFileContent = await readTextFile(file);
        }

        displayUploadedFile(file);
        document.getElementById('parse-button').disabled = false;
        showMessage('File loaded successfully! Click "Parse Guidelines" to extract brand rules.', 'success');
      } catch (error) {
        console.error('File handling error:', error);
        showMessage('Error reading file: ' + error.message, 'error');
        uploadedFile = null;
        uploadedFileContent = null;
      }
    }

    function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    async function extractTextFromPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        let fullText = '';
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        
        return fullText;
      } catch (error) {
        console.error('PDF extraction error:', error);
        throw new Error('Failed to extract text from PDF');
      }
    }

    async function extractImagesAndColorsFromPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        const extractedColors = new Set();
        const images = [];
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          updateProgress((pageNum / pdf.numPages) * 100, `Analyzing page ${pageNum} of ${pdf.numPages}...`);
          
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1.0 });
          
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
          
          // Extract colors from canvas
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const pixels = imageData.data;
          
          // Sample colors (every 50th pixel to avoid too much data)
          for (let i = 0; i < pixels.length; i += 200) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            const a = pixels[i + 3];
            
            // Skip transparent or white/black pixels
            if (a > 200 && !(r > 240 && g > 240 && b > 240) && !(r < 15 && g < 15 && b < 15)) {
              const hex = rgbToHex(r, g, b);
              extractedColors.add(hex);
            }
          }
          
          images.push(canvas.toDataURL('image/png'));
        }
        
        return {
          colors: Array.from(extractedColors),
          images: images
        };
      } catch (error) {
        console.error('Image extraction error:', error);
        throw new Error('Failed to extract images from PDF');
      }
    }

    async function performOCR(images) {
      if (typeof Tesseract === 'undefined') {
        console.warn('Tesseract.js not loaded, skipping OCR');
        return '';
      }

      let ocrText = '';
      
      for (let i = 0; i < images.length; i++) {
        updateProgress(((i + 1) / images.length) * 100, `Running OCR on page ${i + 1} of ${images.length}...`);
        
        try {
          const result = await Tesseract.recognize(images[i], 'eng');
          ocrText += result.data.text + '\n';
        } catch (error) {
          console.error('OCR error on page', i + 1, error);
        }
      }
      
      return ocrText;
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => {
        const hex = Math.round(x).toString(16).toUpperCase();
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    function displayUploadedFile(file) {
      const container = document.getElementById('uploaded-file-display');
      const sizeKB = (file.size / 1024).toFixed(2);
      
      container.innerHTML = `
        <div class="uploaded-file">
          <div class="uploaded-file-icon">üìÑ</div>
          <div class="uploaded-file-info">
            <div class="uploaded-file-name">${escapeHtml(file.name)}</div>
            <div class="uploaded-file-size">${sizeKB} KB</div>
          </div>
          <button class="uploaded-file-remove" onclick="removeFile()" title="Remove file">√ó</button>
        </div>
      `;
    }

    function removeFile() {
      uploadedFile = null;
      uploadedFileContent = null;
      pdfImages = [];
      document.getElementById('uploaded-file-display').innerHTML = '';
      document.getElementById('file-input').value = '';
      document.getElementById('parse-button').disabled = true;
      document.getElementById('guidelines-preview-section').style.display = 'none';
    }

    function updateProgress(percent, text) {
      document.getElementById('parse-progress').style.display = 'block';
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('progress-text').textContent = text;
    }

    function hideProgress() {
      document.getElementById('parse-progress').style.display = 'none';
      document.getElementById('progress-fill').style.width = '0%';
    }

    async function parseGuidelines() {
      if (!uploadedFileContent) {
        showMessage('Please upload a file first.', 'error');
        return;
      }

      if (!uploadedFileContent.trim()) {
        showMessage('The file appears to be empty.', 'error');
        return;
      }

      const btn = document.getElementById('parse-button');
      btn.disabled = true;
      btn.innerHTML = 'üîç Parsing... <span class="loading-spinner"></span>';

      const deepAnalysis = document.getElementById('deep-analysis').checked;
      const ocrAnalysis = document.getElementById('ocr-analysis').checked;
      const aiAnalysis = document.getElementById('ai-analysis').checked;
      
      let content = uploadedFileContent;
      let extractedColors = [];
      let aiUnderstanding = null;
      
      try {
        if (uploadedFile.name.endsWith('.pdf')) {
          if (deepAnalysis) {
            updateProgress(10, 'Extracting images and colors from PDF...');
            const extracted = await extractImagesAndColorsFromPDF(uploadedFile);
            extractedColors = extracted.colors;
            pdfImages = extracted.images;
            
            if (ocrAnalysis && pdfImages.length > 0) {
              updateProgress(30, 'Running OCR analysis...');
              const ocrText = await performOCR(pdfImages);
              content += '\n\n' + ocrText;
            }
          }
        }
        
        // AI Analysis
        if (aiAnalysis) {
          const apiKey = document.getElementById('api-key-input').value.trim();
          if (apiKey) {
            // Save API key to Figma storage
            parent.postMessage({ 
              pluginMessage: { 
                type: 'save-api-key',
                apiKey: apiKey
              } 
            }, '*');
            
            updateProgress(60, 'AI is reading and understanding your brand guidelines...');
            
            try {
              aiUnderstanding = await analyzeWithAI(content, pdfImages.slice(0, 3), apiKey);
            } catch (error) {
              console.error('AI analysis error:', error);
              showMessage('AI analysis failed: ' + error.message + '. Continuing with standard analysis...', 'error');
            }
          } else {
            showMessage('AI analysis requires an API key. Continuing with standard analysis...', 'info');
          }
        }
        
        updateProgress(90, 'Parsing guidelines...');
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'parse-guidelines',
            content: content,
            filename: uploadedFile.name,
            extractedColors: extractedColors,
            aiUnderstanding: aiUnderstanding
          } 
        }, '*');
      } catch (error) {
        console.error('Parse error:', error);
        showMessage('Error during analysis: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        hideProgress();
      }
    }

    async function analyzeWithAI(content, imageDataUrls, apiKey) {
      const prompt = `You are a brand design expert analyzing brand guidelines. Read and deeply understand this brand guidelines document.

DOCUMENT CONTENT:
${content.substring(0, 8000)}

Please analyze and provide a comprehensive understanding including:

1. **Brand Personality**: What is the overall feeling, tone, and personality of this brand? (e.g., playful, professional, luxurious, minimal, bold)

2. **Visual Style**: Describe the visual aesthetic and design direction. What emotions should designs evoke?

3. **Core Values**: What values and principles does this brand stand for?

4. **Target Audience**: Who is this brand designed for? What demographic and psychographic characteristics?

5. **Color Psychology**: Beyond just hex codes, what do the colors represent? What feelings should they evoke?

6. **Typography Character**: What personality do the fonts convey? How should text feel?

7. **Imagery Style**: What kind of images align with this brand? (photography style, illustration style, etc.)

8. **Design Dos and Don'ts**: Key principles for what should and shouldn't be done

9. **Brand Essence**: In one sentence, what is the essence of this brand?

Respond in JSON format with these exact keys: brandPersonality, visualStyle, coreValues, targetAudience, colorPsychology, typographyCharacter, imageryStyle, designPrinciples, brandEssence`;

      const messages = [
        {
          role: 'user',
          content: [
            { type: 'text', text: prompt }
          ]
        }
      ];

      // Add images if available
      if (imageDataUrls && imageDataUrls.length > 0) {
        imageDataUrls.forEach(dataUrl => {
          const base64Data = dataUrl.split(',')[1];
          messages[0].content.push({
            type: 'image',
            source: {
              type: 'base64',
              media_type: 'image/png',
              data: base64Data
            }
          });
        });
      }

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-3-5-sonnet-20241022',
          max_tokens: 2000,
          messages: messages
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error('API request failed: ' + error);
      }

      const data = await response.json();
      const textContent = data.content.find(c => c.type === 'text');
      
      if (!textContent) {
        throw new Error('No text response from AI');
      }

      // Extract JSON from response
      const jsonMatch = textContent.text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      throw new Error('Could not parse AI response as JSON');
    }

    async function analyzeSelectionWithAI(selectionData, guidelines, apiKey) {
      const prompt = `You are a brand design expert. Analyze this Figma design against the brand guidelines.

BRAND UNDERSTANDING:
${JSON.stringify(guidelines.aiUnderstanding, null, 2)}

DESIGN BEING ANALYZED:
${JSON.stringify(selectionData, null, 2)}

Evaluate:
1. Does the design match the brand personality and visual style?
2. Are colors used appropriately for the brand message?
3. Does typography align with brand character?
4. Overall brand alignment score (0-100)
5. Specific feedback on what works and what doesn't

Respond in JSON format with: alignmentScore, personalityMatch, colorUsage, typographyAlignment, imageStyle, overallFeedback, specificIssues, recommendations`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-3-5-sonnet-20241022',
          max_tokens: 1500,
          messages: [{
            role: 'user',
            content: prompt
          }]
        })
      });

      if (!response.ok) {
        throw new Error('AI analysis failed');
      }

      const data = await response.json();
      const textContent = data.content.find(c => c.type === 'text');
      
      const jsonMatch = textContent.text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      return null;
    }

    function displayGuidelinesPreview(guidelines) {
      const preview = document.getElementById('guidelines-preview-content');
      const section = document.getElementById('guidelines-preview-section');
      
      let html = '';
      
      // AI Understanding Section
      if (guidelines.aiUnderstanding) {
        const ai = guidelines.aiUnderstanding;
        
        html += '<div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">';
        html += '<h4 style="margin: 0 0 12px 0; font-family: Inter, sans-serif; font-size: 14px;">ü§ñ AI Brand Understanding</h4>';
        
        if (ai.brandEssence) {
          html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; margin-bottom: 12px; font-style: italic; font-size: 12px; line-height: 1.6;">';
          html += '"' + escapeHtml(ai.brandEssence) + '"';
          html += '</div>';
        }
        
        if (ai.brandPersonality) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Brand Personality:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.brandPersonality) + '</p>';
          html += '</div>';
        }
        
        if (ai.visualStyle) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Visual Style:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.visualStyle) + '</p>';
          html += '</div>';
        }
        
        if (ai.targetAudience) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Target Audience:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.targetAudience) + '</p>';
          html += '</div>';
        }
        
        if (ai.colorPsychology) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">üé® Color Psychology:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.colorPsychology) + '</p>';
          html += '</div>';
        }
        
        if (ai.imageryStyle) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">üì∏ Imagery Style:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.imageryStyle) + '</p>';
          html += '</div>';
        }
        
        html += '</div>';
      }
      
      // Document Analysis Section
      if (guidelines.documentAnalysis) {
        const da = guidelines.documentAnalysis;
        
        html += '<div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 6px;">';
        html += '<h4 style="margin: 0 0 8px 0; font-family: Inter, sans-serif;">üìä Guidelines Quality Score</h4>';
        
        // Score bar
        const scoreColor = da.score >= 80 ? '#28a745' : da.score >= 60 ? '#ffc107' : '#dc3545';
        html += '<div style="background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden; margin-bottom: 12px;">';
        html += '<div style="background: ' + scoreColor + '; height: 100%; width: ' + da.score + '%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px; font-family: Inter, sans-serif;">';
        html += da.score + '%';
        html += '</div></div>';
        
        // Strengths
        if (da.strengths.length > 0) {
          html += '<div style="margin-bottom: 8px;"><strong style="color: #28a745; font-family: Inter, sans-serif;">‚úì Strengths:</strong><ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 10px;">';
          da.strengths.forEach(s => {
            html += '<li>' + escapeHtml(s) + '</li>';
          });
          html += '</ul></div>';
        }
        
        // Weaknesses
        if (da.weaknesses.length > 0) {
          html += '<div style="margin-bottom: 8px;"><strong style="color: #dc3545; font-family: Inter, sans-serif;">‚ö† Gaps:</strong><ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 10px;">';
          da.weaknesses.forEach(w => {
            html += '<li>' + escapeHtml(w) + '</li>';
          });
          html += '</ul></div>';
        }
        
        // Recommendations
        if (da.recommendations.length > 0) {
          html += '<div><strong style="color: #17a2b8; font-family: Inter, sans-serif;">üí° Recommendations:</strong><ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 10px;">';
          da.recommendations.forEach(r => {
            html += '<li>' + escapeHtml(r) + '</li>';
          });
          html += '</ul></div>';
        }
        
        html += '</div>';
      }
      
      // Parsed data (collapsed)
      html += '<details style="font-family: Courier New, monospace; font-size: 10px; line-height: 1.4;">';
      html += '<summary style="cursor: pointer; font-family: Inter, sans-serif; font-size: 11px; font-weight: 600; padding: 8px; background: #f0f0f0; border-radius: 4px;">üìã View Raw Parsed Data</summary>';
      html += '<pre style="margin: 8px 0 0 0; padding: 12px; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">';
      html += escapeHtml(JSON.stringify(guidelines, null, 2));
      html += '</pre></details>';
      
      preview.innerHTML = html;
      section.style.display = 'block';
    }

    function analyzeSelection() {
      parent.postMessage({ 
        pluginMessage: { type: 'analyze-selection' } 
      }, '*');
    }

    function enableChat() {
      // Remove welcome message
      const welcome = document.getElementById('chat-welcome');
      if (welcome) {
        welcome.remove();
      }
      
      // Check if API key is available
      const apiKeyInput = document.getElementById('api-key-input');
      const hasApiKey = apiKeyInput && apiKeyInput.value.trim().length > 0;
      
      if (hasApiKey) {
        // Enable inputs
        document.getElementById('chat-input').disabled = false;
        document.getElementById('send-chat-btn').disabled = false;
        
        // Update status text
        document.getElementById('chat-status-text').innerHTML = '‚úÖ AI Brand Assistant is ready! Ask me anything about your brand guidelines or designs.';
        
        // Show quick questions
        document.getElementById('quick-questions').style.display = 'block';
        
        // Add welcome message if chat is empty
        if (chatHistory.length === 0) {
          const brandName = parsedGuidelines.aiUnderstanding?.brandEssence || 'your brand';
          addChatMessage('ai', `Hi! üëã I've learned all about ${brandName}. I can help you:\n\n‚Ä¢ Understand your brand guidelines\n‚Ä¢ Validate design decisions\n‚Ä¢ Explore creative ideas\n‚Ä¢ Check Figma designs for compliance\n‚Ä¢ Answer any brand-related questions\n\nWhat would you like to know?`);
        }
      } else {
        // Enable inputs but show warning on first use
        document.getElementById('chat-input').disabled = false;
        document.getElementById('send-chat-btn').disabled = false;
        
        // Update status text with instruction
        document.getElementById('chat-status-text').innerHTML = '‚ö†Ô∏è AI is ready, but you need to add your API key. Type a message to see instructions, or add the key in Upload Guidelines tab.';
        
        // Show quick questions
        document.getElementById('quick-questions').style.display = 'block';
        
        // Add welcome message
        if (chatHistory.length === 0) {
          const brandName = parsedGuidelines.aiUnderstanding?.brandEssence || 'your brand';
          addChatMessage('ai', `Hi! üëã I've learned all about ${brandName}.\n\nTo start chatting, please add your Anthropic API key in the "Upload Guidelines" tab, or I can guide you through getting one!\n\nWhat would you like to do?`);
        }
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!parsedGuidelines || !parsedGuidelines.aiUnderstanding) {
        addChatMessage('system', 'Please upload brand guidelines with AI analysis enabled first (in the Upload Guidelines tab).');
        return;
      }
      
      // Get API key
      const apiKeyInput = document.getElementById('api-key-input');
      const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
      
      if (!apiKey) {
        input.value = '';
        addChatMessage('user', message);
        addChatMessage('system', 'üîë To use AI chat, please add your Anthropic API key:\n\n1. Go to the "Upload Guidelines" tab\n2. Scroll to the API key field\n3. Enter your key (get one free at console.anthropic.com)\n4. Come back here and ask again!\n\nYour message has been saved.');
        
        // Save the message for retry
        input.value = message;
        return;
      }
      
      // Add user message
      addChatMessage('user', message);
      input.value = '';
      
      // Show loading
      const loadingId = 'loading-' + Date.now();
      addChatMessage('ai', '<div class="chat-loading"><span></span><span></span><span></span></div>', loadingId);
      
      try {
        const response = await chatWithAI(message, apiKey);
        
        // Remove loading
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        // Add AI response
        addChatMessage('ai', response);
      } catch (error) {
        console.error('Chat error:', error);
        
        // Remove loading
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        if (error.message.includes('401') || error.message.includes('authentication')) {
          addChatMessage('system', '‚ùå Invalid API key. Please check your Anthropic API key in the Upload Guidelines tab and try again.');
        } else {
          addChatMessage('system', '‚ùå Error: ' + error.message + '\n\nPlease try again or check your internet connection.');
        }
      }
    }

    function askQuickQuestion(question) {
      document.getElementById('chat-input').value = question;
      sendChatMessage();
    }

    function addChatMessage(type, message, id) {
      const container = document.getElementById('chat-messages');
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message ' + type;
      if (id) msgDiv.id = id;
      
      if (message.includes('<div class="chat-loading">')) {
        msgDiv.innerHTML = message;
      } else {
        // Format message with line breaks
        const formattedMessage = message.split('\n').map(line => {
          if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-')) {
            return '<div style="margin-left: 12px;">' + escapeHtml(line) + '</div>';
          }
          return escapeHtml(line);
        }).join('<br>');
        msgDiv.innerHTML = formattedMessage;
      }
      
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
      
      if (type !== 'system' && !message.includes('chat-loading')) {
        chatHistory.push({ 
          role: type === 'user' ? 'user' : 'assistant', 
          content: message 
        });
      }
    }

    async function chatWithAI(userMessage, apiKey) {
      // Build comprehensive context
      let contextPrompt = `You are an expert brand design consultant with deep understanding of the user's brand. You're having a conversation to help them understand and apply their brand guidelines.

BRAND GUIDELINES YOU'VE LEARNED:

Brand Essence: "${parsedGuidelines.aiUnderstanding.brandEssence}"

Brand Personality: ${parsedGuidelines.aiUnderstanding.brandPersonality}

Visual Style: ${parsedGuidelines.aiUnderstanding.visualStyle}

Target Audience: ${parsedGuidelines.aiUnderstanding.targetAudience}

Core Values: ${parsedGuidelines.aiUnderstanding.coreValues || 'Not specified'}

Color Psychology: ${parsedGuidelines.aiUnderstanding.colorPsychology}

Typography Character: ${parsedGuidelines.aiUnderstanding.typographyCharacter}

Imagery Style: ${parsedGuidelines.aiUnderstanding.imageryStyle}

Design Principles: ${parsedGuidelines.aiUnderstanding.designPrinciples || 'Not specified'}

TECHNICAL SPECIFICATIONS:
- Colors: ${parsedGuidelines.colors.map(c => c.name + ' (' + c.hex + ')').join(', ')}
- Fonts: ${parsedGuidelines.typography.fonts.map(f => f.family).join(', ')}
- Font Sizes: ${parsedGuidelines.typography.sizes.join('px, ')}px
- Spacing Scale: ${parsedGuidelines.spacing.scale.join(', ')}${parsedGuidelines.spacing.unit}`;

      if (currentAnalysisData) {
        contextPrompt += `

CURRENT FIGMA DESIGN ANALYSIS:
Element: ${currentAnalysisData.name} (${currentAnalysisData.elementType})
Issues: ${currentAnalysisData.violations.map(v => v.message).join('; ')}
Working Well: ${currentAnalysisData.goodPractices.join('; ')}`;
      }

      contextPrompt += `

User's question: ${userMessage}

Please provide helpful, specific advice that references the brand personality, values, and guidelines. Be conversational but professional. Give actionable recommendations when appropriate.`;

      const messages = chatHistory.slice(-10).map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      messages.push({
        role: 'user',
        content: contextPrompt
      });

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-3-5-sonnet-20241022',
          max_tokens: 1500,
          messages: messages
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error('API request failed: ' + error);
      }

      const data = await response.json();
      const textContent = data.content.find(c => c.type === 'text');
      
      if (!textContent) {
        throw new Error('No text response from AI');
      }

      return textContent.text;
    }

    function displayAnalysis(analysis) {
      const container = document.getElementById('analysis-results');
      
      let html = '<div class="analysis-result">';
      
      // Header with selection count
      if (analysis.selectionCount && analysis.selectionCount > 1) {
        html += `<div class="section">
          <h3>Section Analysis <span class="stat-badge">${analysis.selectionCount} elements</span></h3>
          <p style="color: #666; font-size: 11px;">Analyzing ${analysis.selectionCount} selected elements</p>
        </div>`;
      } else {
        html += `<div class="section">
          <h3>Analysis: ${escapeHtml(analysis.name)}</h3>
          <p style="color: #666; font-size: 11px;">Element type: ${analysis.elementType}</p>
        </div>`;
      }

      // AI Chat Prompt Card (if AI is available)
      if (parsedGuidelines && parsedGuidelines.aiUnderstanding) {
        html += '<div class="analysis-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">';
        html += '<h4 style="color: white; margin-bottom: 8px;">üí¨ Want personalized feedback?</h4>';
        html += '<p style="margin: 0 0 12px 0; font-size: 11px; line-height: 1.6; opacity: 0.95;">Scroll down to chat with AI about your design! Ask for specific improvements, alternative ideas, or brand alignment feedback.</p>';
        html += '<div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; font-size: 10px; font-style: italic;">üí° Try: "How can I make this more on-brand?" or "Suggest better color combinations"</div>';
        html += '</div>';
      }

      // Intelligent Insights Section
      if (analysis.insights) {
        const insights = analysis.insights;
        
        html += '<div class="analysis-card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea;">';
        html += '<h4 style="color: #667eea;">üß† Intelligent Analysis</h4>';
        
        // Overall Assessment
        if (insights.overall) {
          html += '<div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">';
          html += '<strong style="display: block; margin-bottom: 4px; color: #333;">Overall Assessment:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.6;">' + escapeHtml(insights.overall) + '</p>';
          html += '</div>';
        }
        
        // Brand Alignment (if AI enhanced)
        if (insights.brandAlignment) {
          html += '<div style="padding: 10px; background: #f0f2ff; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #667eea;">';
          html += '<strong style="display: block; margin-bottom: 4px; color: #667eea;">üéØ Brand Alignment:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.6;">' + escapeHtml(insights.brandAlignment) + '</p>';
          html += '</div>';
        }
        
        // Color Consistency
        if (insights.colorConsistency) {
          html += '<div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">';
          html += '<strong style="display: block; margin-bottom: 4px; color: #333;">üé® Color Consistency:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.6;">' + escapeHtml(insights.colorConsistency) + '</p>';
          html += '</div>';
        }
        
        // Typography Consistency
        if (insights.typographyConsistency) {
          html += '<div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">';
          html += '<strong style="display: block; margin-bottom: 4px; color: #333;">‚úçÔ∏è Typography:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.6;">' + escapeHtml(insights.typographyConsistency) + '</p>';
          html += '</div>';
        }
        
        // Design System
        if (insights.designSystem) {
          html += '<div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">';
          html += '<strong style="display: block; margin-bottom: 4px; color: #333;">üéØ Design System:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.6;">' + escapeHtml(insights.designSystem) + '</p>';
          html += '</div>';
        }
        
        // Priority Improvements
        if (insights.improvements && insights.improvements.length > 0) {
          html += '<div style="padding: 10px; background: #fff9e6; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ffc107;">';
          html += '<strong style="display: block; margin-bottom: 6px; color: #333;">üîß Action Items:</strong>';
          html += '<ol style="margin: 0; padding-left: 20px; font-size: 11px; line-height: 1.6;">';
          insights.improvements.forEach(imp => {
            const isPriority = imp.includes('PRIORITY') || imp.includes('URGENT');
            const style = isPriority ? 'font-weight: 600; color: #dc3545;' : '';
            html += '<li style="' + style + '">' + escapeHtml(imp) + '</li>';
          });
          html += '</ol></div>';
        }
        
        // Best Practices
        if (insights.bestPractices && insights.bestPractices.length > 0) {
          html += '<div style="padding: 10px; background: #d4edda; border-radius: 6px; border-left: 3px solid #28a745;">';
          html += '<strong style="display: block; margin-bottom: 6px; color: #333;">üíö Pro Tips:</strong>';
          html += '<ul style="margin: 0; padding-left: 20px; font-size: 11px; line-height: 1.6;">';
          insights.bestPractices.forEach(tip => {
            html += '<li>' + escapeHtml(tip) + '</li>';
          });
          html += '</ul></div>';
        }
        
        html += '</div>';
      }

      // Violations
      if (analysis.violations && analysis.violations.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚ö†Ô∏è Issues Found <span class="stat-badge" style="background: #dc3545;">' + analysis.violations.length + '</span></h4>';
        html += '<ul class="violations-list">';
        analysis.violations.forEach(v => {
          html += `<li class="${v.severity}">
            ${escapeHtml(v.message)}
            <span class="severity-badge severity-${v.severity}">${v.severity}</span>
          </li>`;
        });
        html += '</ul></div>';
      }

      // Good practices
      if (analysis.goodPractices && analysis.goodPractices.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚úÖ What\'s Working Well <span class="stat-badge" style="background: #28a745;">' + analysis.goodPractices.length + '</span></h4>';
        html += '<ul class="good-list">';
        analysis.goodPractices.forEach(g => {
          html += `<li>${escapeHtml(g)}</li>`;
        });
        html += '</ul></div>';
      }

      // Suggestions
      if (analysis.suggestions && analysis.suggestions.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>üí° Suggestions</h4>';
        html += '<ul class="suggestions-list">';
        analysis.suggestions.forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
      }

      html += '</div>';
      container.innerHTML = html;
      
      // Scroll to results
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type !== 'info') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>