<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      padding: 16px; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      font-size: 12px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: -16px -16px 16px -16px;
      padding: 20px 16px;
      color: white;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .header p {
      margin: 4px 0 0 0;
      font-size: 11px;
      opacity: 0.9;
    }
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }
    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      position: relative;
      transition: color 0.2s;
      white-space: nowrap;
    }
    .tab.active {
      color: #667eea;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #667eea;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h3 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .button {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .button:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    .button:active {
      transform: translateY(0);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 11px;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      display: none;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border-left: 3px solid #28a745;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 3px solid #dc3545;
    }
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 3px solid #17a2b8;
    }
    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .file-upload:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .file-upload.dragover {
      border-color: #667eea;
      background: #f0f2ff;
      border-style: solid;
    }
    .file-upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    .file-upload-text {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }
    .file-upload-subtext {
      font-size: 11px;
      color: #999;
    }
    .uploaded-file {
      background: #f0f2ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .uploaded-file-icon {
      font-size: 24px;
    }
    .uploaded-file-info {
      flex: 1;
    }
    .uploaded-file-name {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }
    .uploaded-file-size {
      font-size: 10px;
      color: #666;
    }
    .uploaded-file-remove {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .analysis-result {
      margin-top: 16px;
    }
    .analysis-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .analysis-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .violations-list, .good-list, .suggestions-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .violations-list li, .good-list li, .suggestions-list li {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.5;
    }
    .violations-list li {
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .violations-list li.high {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    .good-list li {
      background: #d4edda;
      border-left: 3px solid #28a745;
    }
    .suggestions-list li {
      background: #d1ecf1;
      border-left: 3px solid #17a2b8;
    }
    .severity-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 6px;
    }
    .severity-high {
      background: #dc3545;
      color: white;
    }
    .severity-medium {
      background: #ffc107;
      color: #000;
    }
    .severity-low {
      background: #17a2b8;
      color: white;
    }
    .guidelines-preview {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .guidelines-preview h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #333;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #file-input {
      display: none;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }
    .checkbox-group {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #333;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .checkbox-label:last-child {
      margin-bottom: 0;
    }
    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .stat-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }
    .grade-category {
      background: white;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .grade-category-header {
      padding: 14px 16px;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }
    .grade-category-header:hover {
      opacity: 0.9;
    }
    .grade-category.green .grade-category-header {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .grade-category.yellow .grade-category-header {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
    .grade-category.red .grade-category-header {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .grade-status-icon {
      font-size: 16px;
      min-width: 20px;
    }
    .grade-category-title {
      flex: 1;
    }
    .grade-category-count {
      font-size: 10px;
      opacity: 0.8;
      margin-left: auto;
    }
    .grade-category-content {
      padding: 12px 16px;
      background: #f8f9fa;
      display: none;
      font-size: 11px;
      line-height: 1.6;
      border-top: 1px solid #e0e0e0;
    }
    .grade-category-content.active {
      display: block;
    }
    .grade-violation-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 11px;
      border-left: 3px solid;
    }
    .grade-violation-item.critical {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    .grade-violation-item.warning {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }
    .grade-violation-item.pass {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    .grade-violation-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .grade-violation-reason {
      opacity: 0.9;
      font-size: 10px;
      line-height: 1.5;
    }
    .color-swatch {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: inline-block;
      cursor: pointer;
      position: relative;
    }
    .color-swatch-label {
      font-size: 9px;
      position: absolute;
      bottom: -16px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      background: white;
      padding: 2px 4px;
      border-radius: 2px;
      border: 1px solid #ddd;
    }
    .font-badge {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }
    .no-issues {
      color: #28a745;
      font-weight: 600;
      padding: 12px;
      text-align: center;
      font-size: 12px;
    }
    .frame-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      border: 2px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® Brand Guidelines Checker</h1>
    <p>Upload guidelines and analyze Figma selections</p>
  </div>

  <div id="message"></div>

  <div class="tab-container">
    <button class="tab active" data-tab="upload">Upload Guidelines</button>
    <button class="tab" data-tab="analyze">Analyze Selection</button>
    <button class="tab" data-tab="grade">üìä Compliance Grade</button>
  </div>

  <!-- Upload Tab -->
  <div id="upload-tab" class="tab-content active">
    <div class="section">
      <h3>Upload Brand Guidelines Document</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Upload a TXT or PDF file containing your brand guidelines. The plugin will parse colors, fonts, spacing, images, and layouts.
      </p>

      <input type="file" id="file-input" accept=".txt,.pdf">
      
      <div class="file-upload" id="drop-zone">
        <div class="file-upload-icon">üìÅ</div>
        <div class="file-upload-text">Drop your guidelines here</div>
        <div class="file-upload-subtext">Supports TXT and PDF (max 50MB)</div>
      </div>

      <div id="uploaded-file-display"></div>

      <div class="checkbox-group" id="parse-options">
        <label class="checkbox-label">
          <input type="checkbox" id="deep-analysis" checked>
          <span>üîç Deep Analysis (Extract images, colors from PDF pages)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ocr-analysis">
          <span>üì∑ OCR Analysis (Extract text from images - slower)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ai-analysis" checked>
          <span>ü§ñ AI Analysis (Understand brand voice, tone, and visual style)</span>
        </label>
      </div>

      <div id="api-endpoint-section" style="margin-top: 12px;">
        <label style="display: block; font-size: 11px; font-weight: 500; color: #666; margin-bottom: 4px;">
          Backend API URL (Required)
        </label>
        <input type="text" id="api-endpoint-input" placeholder="https://your-backend.vercel.app" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
        <p style="font-size: 9px; color: #999; margin: 4px 0 0 0;">
          Enter your backend API endpoint (e.g., https://my-app.vercel.app)
        </p>
      </div>

      <div id="api-key-section" style="margin-top: 12px;">
        <label style="display: block; font-size: 11px; font-weight: 500; color: #666; margin-bottom: 4px;">
          Anthropic API Key (Required for AI features)
        </label>
        <input type="password" id="api-key-input" placeholder="sk-ant-..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
        <p style="font-size: 9px; color: #999; margin: 4px 0 0 0;">
          Get your API key at <a href="https://console.anthropic.com" target="_blank" style="color: #667eea;">console.anthropic.com</a>
        </p>
      </div>

      <div id="parse-progress" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">Processing...</div>
      </div>

      <button class="button" id="parse-button" disabled>
        üîç Parse Guidelines
      </button>
    </div>

    <div id="guidelines-preview-section" style="display: none;">
      <div class="section">
        <h3>Parsed Guidelines</h3>
        <div class="guidelines-preview" id="guidelines-preview-content"></div>
      </div>
    </div>
  </div>

  <!-- Analyze Tab -->
  <div id="analyze-tab" class="tab-content">
    <!-- AI Chat Section -->
    <div class="section" id="ai-chat-section">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <h3 style="margin: 0;">üí¨ AI Brand Assistant</h3>
        <div id="chat-status-badge" style="padding: 4px 12px; background: #e0e0e0; color: #666; border-radius: 12px; font-size: 10px; font-weight: 600;">
          ‚è≥ Waiting for guidelines...
        </div>
      </div>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        <span id="chat-status-text">Upload your brand guidelines with AI analysis enabled to chat about your brand.</span>
      </p>
      
      <div id="chat-messages" style="background: #f8f9fa; border-radius: 8px; padding: 12px; min-height: 200px; max-height: 350px; overflow-y: auto; margin-bottom: 12px;">
        <div id="chat-welcome" style="text-align: center; color: #999; font-size: 11px; padding: 30px 20px;">
          <div style="font-size: 40px; margin-bottom: 12px;">ü§ñ</div>
          <p style="margin: 0 0 8px 0;"><strong>AI Brand Assistant Ready</strong></p>
          <p style="margin: 0;">Upload your brand guidelines with AI analysis enabled to chat.</p>
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <input 
          type="text" 
          id="chat-input" 
          placeholder="Ask about your brand, guidelines, or get design feedback..."
          style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 12px; transition: border-color 0.2s;"
          onkeypress="if(event.key === 'Enter') sendChatMessage()"
          onfocus="this.style.borderColor='#667eea'"
          onblur="this.style.borderColor='#ddd'"
          disabled
        >
        <button class="button" onclick="sendChatMessage()" id="send-chat-btn" style="width: auto; padding: 10px 20px;" disabled>
          Send
        </button>
      </div>
    </div>

    <!-- Figma Analysis Section -->
    <div class="section">
      <h3>üîç Analyze Figma Selection</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Select elements in Figma to check them against your brand guidelines with AI visual analysis.
      </p>
      <button class="button" id="analyze-button">üîç Analyze Selected Elements</button>
      <p style="font-size: 10px; color: #999; margin-top: 8px; text-align: center;">
        Tip: Select multiple elements for a section overview
      </p>
    </div>

    <div id="analysis-results"></div>
  </div>

  <!-- Compliance Grade Tab -->
  <div id="grade-tab" class="tab-content">
    <div class="section">
      <h3>üìä Brand Compliance Grade</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Select a frame to grade its compliance against your brand guidelines.
      </p>
      <button class="button" id="grade-button">üéØ Grade Selected Frame</button>
    </div>

    <div id="grade-results" style="display: none;">
      <!-- Stats Grid -->
      <div class="section">
        <h3>üìä Compliance Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div style="background: #d4edda; padding: 16px; border-radius: 6px; text-align: center; border-left: 4px solid #28a745;">
            <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="stat-pass">0</div>
            <div style="font-size: 11px; color: #155724; font-weight: 500; margin-top: 4px;">Passing</div>
          </div>
          <div style="background: #fff3cd; padding: 16px; border-radius: 6px; text-align: center; border-left: 4px solid #ffc107;">
            <div style="font-size: 24px; font-weight: 700; color: #ffc107;" id="stat-warning">0</div>
            <div style="font-size: 11px; color: #856404; font-weight: 500; margin-top: 4px;">Warnings</div>
          </div>
          <div style="background: #f8d7da; padding: 16px; border-radius: 6px; text-align: center; border-left: 4px solid #dc3545;">
            <div style="font-size: 24px; font-weight: 700; color: #dc3545;" id="stat-critical">0</div>
            <div style="font-size: 11px; color: #721c24; font-weight: 500; margin-top: 4px;">Critical</div>
          </div>
        </div>
      </div>

      <!-- Creative Preview -->
      <div class="section">
        <h3>üì∏ Frame Details</h3>
        <div id="creative-preview" style="background: #f8f9fa; border-radius: 8px; overflow: hidden; max-height: 200px; margin-bottom: 12px;">
          <img id="preview-image" style="width: 100%; height: auto; display: none;" src="" alt="Preview">
        </div>
        <div style="font-size: 11px; color: #666;">
          <strong id="preview-name">Frame Name</strong>
          <div id="detected-elements" style="margin-top: 8px; font-size: 10px;"></div>
        </div>
      </div>

      <!-- Detected Properties -->
      <div class="section">
        <h3>üé® Detected Elements</h3>
        <div id="detected-colors" style="margin-bottom: 12px;">
          <div style="font-size: 10px; font-weight: 600; margin-bottom: 6px; color: #666;">Colors:</div>
          <div id="colors-list" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
        </div>
        <div id="detected-fonts" style="margin-bottom: 12px;">
          <div style="font-size: 10px; font-weight: 600; margin-bottom: 6px; color: #666;">Fonts:</div>
          <div id="fonts-list" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
        </div>
      </div>

      <!-- Violations by Category -->
      <div id="violations-container"></div>
    </div>
  </div>

  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // ========== GLOBAL VARIABLES ==========
    let uploadedFile = null;
    let uploadedFileContent = null;
    let uploadedPDFBase64 = null; // NEW: Store PDF as base64
    let uploadedPDFName = null;   // NEW: Store PDF filename
    let parsedGuidelines = null;
    let pdfImages = [];
    let chatHistory = [];
    let currentAnalysisData = null;
    let complianceReportData = null;
    let gradeFrameData = null;

    // ========== INITIALIZATION ==========
    window.onload = () => {
      setupDragAndDrop();
      setupTabs();
      setupButtons();
      setupAPIKeySection();
      parent.postMessage({ pluginMessage: { type: 'load-guidelines' } }, '*');
    };

    function setupAPIKeySection() {
      const aiCheckbox = document.getElementById('ai-analysis');
      const apiKeySection = document.getElementById('api-key-section');
      const apiEndpointSection = document.getElementById('api-endpoint-section');
      
      aiCheckbox.addEventListener('change', (e) => {
        apiKeySection.style.display = e.target.checked ? 'block' : 'none';
        apiEndpointSection.style.display = e.target.checked ? 'block' : 'none';
      });
      
      parent.postMessage({ pluginMessage: { type: 'load-api-key' } }, '*');
      parent.postMessage({ pluginMessage: { type: 'load-api-endpoint' } }, '*');
      
      if (aiCheckbox.checked) {
        apiKeySection.style.display = 'block';
        apiEndpointSection.style.display = 'block';
      }
    }

    // ========== MESSAGE HANDLERS ==========
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      // NEW: Handle chat response from plugin
      if (msg.type === 'chat-response') {
        const loadingMsg = document.querySelector('.chat-message[id^="loading-"]');
        if (loadingMsg) loadingMsg.remove();
        addChatMessage('ai', msg.response);
        return;
      }
      
      if (msg.type === 'chat-error') {
        const loadingMsg = document.querySelector('.chat-message[id^="loading-"]');
        if (loadingMsg) loadingMsg.remove();
        addChatMessage('system', '‚ùå Error: ' + msg.error);
        return;
      }
      
      // NEW HANDLER: AI analysis with images
      if (msg.type === 'analysis-ready-for-ai') {
        console.log('üì∏ Received frames for AI analysis:', msg.frameImages.length);
        handleAIAnalysis(msg);
        return;
      }
      
      if (msg.type === 'grade-data-captured') {
        gradeFrameData = msg.frameData;
        console.log('üìä Grade frame data captured:', gradeFrameData);
      }

      if (msg.type === 'grade-complete') {
        const btn = document.getElementById('grade-button');
        btn.disabled = false;
        btn.innerHTML = 'üéØ Grade Selected Frame';
        
        if (msg.data) {
          complianceReportData = msg.data;
          displayComplianceGrade(msg.data, gradeFrameData);
          switchTab('grade');
        } else if (msg.error) {
          showMessage('Grading error: ' + msg.error, 'error');
        }
      }
      
      if (msg.type === 'guidelines-loaded') {
        if (msg.guidelines) {
          parsedGuidelines = msg.guidelines;
          displayGuidelinesPreview(msg.guidelines);
          if (msg.guidelines.aiUnderstanding) {
            enableChat();
          }
        }
      }
      
      if (msg.type === 'api-key-loaded') {
        if (msg.apiKey) {
          document.getElementById('api-key-input').value = msg.apiKey;
        }
      }

      if (msg.type === 'api-endpoint-loaded') {
        if (msg.endpoint) {
          document.getElementById('api-endpoint-input').value = msg.endpoint;
        }
      }
      
      if (msg.type === 'parse-success') {
        parsedGuidelines = msg.guidelines;
        displayGuidelinesPreview(msg.guidelines);
        showMessage('Guidelines parsed and saved successfully!', 'success');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        
        if (msg.guidelines.aiUnderstanding) {
          enableChat();
          showMessage('AI Brand Assistant is now ready! Go to the Analyze tab to chat.', 'success');
        }
      }
      
      if (msg.type === 'analysis-complete') {
        currentAnalysisData = msg.analysis;
        displayAnalysis(msg.analysis);
      }
      
      if (msg.type === 'error') {
        showMessage(msg.message, 'error');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
      }
    };

    // ========== NEW: AI ANALYSIS HANDLER (WITH PDF) ==========
    async function handleAIAnalysis(msg) {
      const btn = document.getElementById('analyze-button');
      
      try {
        const apiKey = document.getElementById('api-key-input').value.trim();
        const endpoint = document.getElementById('api-endpoint-input').value.trim();
        
        if (!apiKey || !endpoint) {
          showMessage('API key and endpoint required for AI analysis', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üîç Analyze Selected Elements';
          return;
        }
        
        // Clean endpoint
        let cleanEndpoint = endpoint;
        if (!cleanEndpoint.startsWith('http://') && !cleanEndpoint.startsWith('https://')) {
          cleanEndpoint = 'https://' + cleanEndpoint;
        }
        if (cleanEndpoint.endsWith('/')) {
          cleanEndpoint = cleanEndpoint.slice(0, -1);
        }
        
        btn.innerHTML = 'ü§ñ AI analyzing with PDF + images... <span class="loading-spinner"></span>';
        
        console.log('üì§ Calling backend API:', cleanEndpoint + '/api/analyze-frames');
        console.log('üì∏ Sending', msg.frameImages.length, 'images');
        console.log('üìÑ Including PDF:', uploadedPDFName, uploadedPDFBase64 ? 'Yes' : 'No');
        
        // Call backend API with images AND PDF
        const response = await fetch(`${cleanEndpoint}/api/analyze-frames`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            frameImages: msg.frameImages,
            guidelines: msg.guidelines,
            apiKey: apiKey,
            pdfBase64: null  // INCLUDE PDF
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error('API request failed: ' + response.statusText + ' - ' + errorText);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Analysis failed');
        }
        
        console.log('‚úÖ AI analysis complete');
        
        // Display AI analysis results
        displayAIAnalysis(data.data, msg.frameImages);
        
        btn.disabled = false;
        btn.innerHTML = 'üîç Analyze Selected Elements';
        showMessage('AI analysis complete!', 'success');
        
      } catch (error) {
        console.error('‚ùå AI analysis error:', error);
        showMessage('AI analysis error: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîç Analyze Selected Elements';
      }
    }

    // ========== NEW: DISPLAY AI ANALYSIS ==========
    function displayAIAnalysis(analysis, frameImages) {
      const container = document.getElementById('analysis-results');
      
      let html = '<div class="analysis-result">';
      
      // Show analyzed frames with thumbnails
      html += `<div class="section">
        <h3>üé® AI Visual Analysis <span class="stat-badge">${frameImages.length} frame(s)</span></h3>
        <p style="color: #666; font-size: 11px; margin-bottom: 12px;">Claude analyzed the visual design against your brand guidelines</p>
      `;
      
      // Show thumbnails
      if (frameImages.length > 0) {
        html += '<div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">';
        frameImages.forEach(img => {
          html += `<div style="text-align: center;">
            <img src="data:image/png;base64,${img.base64}" class="frame-thumbnail">
            <div style="font-size: 9px; color: #666; margin-top: 4px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(img.name)}</div>
          </div>`;
        });
        html += '</div>';
      }
      
      html += '</div>';
      
      // Summary section
      if (analysis.summary) {
        html += `<div class="analysis-card">
          <h4>üìã Summary</h4>
          <p style="font-size: 11px; line-height: 1.6; color: #333; white-space: pre-wrap;">${escapeHtml(analysis.summary)}</p>
        </div>`;
      }

      // Violations section
      if (analysis.violations && analysis.violations.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚ö†Ô∏è Issues Found <span class="stat-badge" style="background: #dc3545;">' + analysis.violations.length + '</span></h4>';
        html += '<ul class="violations-list">';
        analysis.violations.forEach(v => {
          const severity = v.severity || 'high';
          const message = v.message || v;
          html += `<li class="${severity}">
            ${escapeHtml(message)}
            ${v.severity ? '<span class="severity-badge severity-' + v.severity + '">' + v.severity + '</span>' : ''}
          </li>`;
        });
        html += '</ul></div>';
      }

      // Strengths section
      if (analysis.strengths && analysis.strengths.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚úÖ Strengths <span class="stat-badge" style="background: #28a745;">' + analysis.strengths.length + '</span></h4>';
        html += '<ul class="good-list">';
        analysis.strengths.forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
      }

      // Suggestions section
      if (analysis.suggestions && analysis.suggestions.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>üí° Suggestions</h4>';
        html += '<ul class="suggestions-list">';
        analysis.suggestions.forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
      }

      html += '</div>';
      container.innerHTML = html;
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ========== TAB MANAGEMENT ==========
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // ========== BUTTON SETUP ==========
    function setupButtons() {
      document.getElementById('parse-button').addEventListener('click', parseGuidelines);
      document.getElementById('analyze-button').addEventListener('click', analyzeSelection);
      document.getElementById('grade-button').addEventListener('click', generateComplianceGrade);
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('drop-zone').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
    }

    // ========== DRAG AND DROP ==========
    function setupDragAndDrop() {
      const dropZone = document.getElementById('drop-zone');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('dragover');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('dragover');
        }, false);
      });

      dropZone.addEventListener('drop', handleDrop, false);
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    // ========== FILE HANDLING (UPDATED) ==========
    async function handleFile(file) {
      const maxSize = 50 * 1024 * 1024;
      const allowedTypes = ['.txt', '.pdf'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedTypes.includes(fileExt)) {
        showMessage('Invalid file type. Please upload TXT or PDF files.', 'error');
        return;
      }

      if (file.size > maxSize) {
        showMessage('File is too large. Maximum size is 50MB.', 'error');
        return;
      }

      uploadedFile = file;
      uploadedPDFName = file.name; // NEW: Store filename
      showMessage('Processing file...', 'info');

      try {
        if (fileExt === '.pdf') {
          // Extract text for parsing
          uploadedFileContent = await extractTextFromPDF(file);
          
          // NEW: ALSO store the PDF as base64 for sending to AI
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64 = e.target.result.split(',')[1];
            uploadedPDFBase64 = base64;
            console.log('‚úÖ PDF stored as base64, length:', base64.length);
          };
          reader.readAsDataURL(file);
          
          if (!uploadedFileContent || uploadedFileContent.trim().length === 0) {
            showMessage('Could not extract text from PDF. The PDF might be image-based or empty.', 'error');
            uploadedFile = null;
            uploadedFileContent = null;
            uploadedPDFBase64 = null;
            return;
          }
        } else {
          uploadedFileContent = await readTextFile(file);
        }

        displayUploadedFile(file);
        document.getElementById('parse-button').disabled = false;
        showMessage('File loaded successfully! Click "Parse Guidelines" to extract brand rules.', 'success');
      } catch (error) {
        console.error('File handling error:', error);
        showMessage('Error reading file: ' + error.message, 'error');
        uploadedFile = null;
        uploadedFileContent = null;
        uploadedPDFBase64 = null;
      }
    }

    function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    async function extractTextFromPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        let fullText = '';
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        
        return fullText;
      } catch (error) {
        console.error('PDF extraction error:', error);
        throw new Error('Failed to extract text from PDF');
      }
    }

    function displayUploadedFile(file) {
      const container = document.getElementById('uploaded-file-display');
      const sizeKB = (file.size / 1024).toFixed(2);
      
      container.innerHTML = `
        <div class="uploaded-file">
          <div class="uploaded-file-icon">üìÑ</div>
          <div class="uploaded-file-info">
            <div class="uploaded-file-name">${escapeHtml(file.name)}</div>
            <div class="uploaded-file-size">${sizeKB} KB</div>
          </div>
          <button class="uploaded-file-remove" onclick="removeFile()" title="Remove file">√ó</button>
        </div>
      `;
    }

    function removeFile() {
      uploadedFile = null;
      uploadedFileContent = null;
      uploadedPDFBase64 = null;
      uploadedPDFName = null;
      pdfImages = [];
      document.getElementById('uploaded-file-display').innerHTML = '';
      document.getElementById('file-input').value = '';
      document.getElementById('parse-button').disabled = true;
      document.getElementById('guidelines-preview-section').style.display = 'none';
    }

    // ========== PROGRESS ==========
    function updateProgress(percent, text) {
      document.getElementById('parse-progress').style.display = 'block';
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('progress-text').textContent = text;
    }

    function hideProgress() {
      document.getElementById('parse-progress').style.display = 'none';
      document.getElementById('progress-fill').style.width = '0%';
    }

    // ========== PARSE GUIDELINES ==========
    async function parseGuidelines() {
      if (!uploadedFileContent) {
        showMessage('Please upload a file first.', 'error');
        return;
      }

      if (!uploadedFileContent.trim()) {
        showMessage('The file appears to be empty.', 'error');
        return;
      }

      const btn = document.getElementById('parse-button');
      btn.disabled = true;
      btn.innerHTML = 'üîç Parsing... <span class="loading-spinner"></span>';

      const aiAnalysis = document.getElementById('ai-analysis').checked;
      
      try {
        updateProgress(60, 'AI is reading and understanding your brand guidelines...');
        
        if (aiAnalysis) {
          const apiKey = document.getElementById('api-key-input').value.trim();
          if (apiKey) {
            parent.postMessage({ 
              pluginMessage: { 
                type: 'save-api-key',
                apiKey: apiKey
              } 
            }, '*');
            
            try {
              await analyzeWithAI(uploadedFileContent, apiKey);
            } catch (error) {
              console.error('AI analysis error:', error);
              showMessage('AI analysis failed: ' + error.message + '. Continuing with standard analysis...', 'error');
            }
          } else {
            showMessage('AI analysis requires an API key. Continuing with standard analysis...', 'info');
          }
        }
        
        updateProgress(90, 'Parsing guidelines...');
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'parse-guidelines',
            content: uploadedFileContent,
            filename: uploadedFile.name
          } 
        }, '*');
      } catch (error) {
        console.error('Parse error:', error);
        showMessage('Error during analysis: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        hideProgress();
      }
    }

    async function analyzeWithAI(content, apiKey) {
      let endpoint = document.getElementById('api-endpoint-input').value.trim();
      
      if (!endpoint || endpoint === 'https://your-backend.vercel.app' || endpoint.includes('YOUR-API-URL')) {
        throw new Error('API endpoint URL is required. Please enter your backend API URL in the "Backend API URL" field.');
      }
      
      if (!endpoint.startsWith('http://') && !endpoint.startsWith('https://')) {
        endpoint = 'https://' + endpoint;
      }
      
      endpoint = endpoint.replace(/\/$/, '');
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-api-endpoint',
          endpoint: endpoint
        } 
      }, '*');

      const response = await fetch(`${endpoint}/api/analyze-guidelines`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          content: content,
          images: [],
          apiKey: apiKey
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'API request failed');
      }

      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Analysis failed');
      }

      parent.postMessage({ 
        pluginMessage: { 
          type: 'parse-guidelines',
          content: content,
          filename: uploadedFile.name,
          aiUnderstanding: data.data
        } 
      }, '*');
    }

    // ========== DISPLAY GUIDELINES PREVIEW ==========
    function displayGuidelinesPreview(guidelines) {
      const preview = document.getElementById('guidelines-preview-content');
      const section = document.getElementById('guidelines-preview-section');
      
      let html = '';
      
      if (guidelines.aiUnderstanding) {
        const ai = guidelines.aiUnderstanding;
        
        html += '<div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">';
        html += '<h4 style="margin: 0 0 12px 0; font-family: Inter, sans-serif; font-size: 14px;">ü§ñ AI Brand Understanding</h4>';
        
        if (ai.brandEssence) {
          html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; margin-bottom: 12px; font-style: italic; font-size: 12px; line-height: 1.6;">';
          html += '"' + escapeHtml(ai.brandEssence) + '"';
          html += '</div>';
        }
        
        if (ai.brandPersonality) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Brand Personality:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.brandPersonality) + '</p>';
          html += '</div>';
        }
        
        html += '</div>';
      }
      
      html += '<details style="font-family: Courier New, monospace; font-size: 10px; line-height: 1.4;">';
      html += '<summary style="cursor: pointer; font-family: Inter, sans-serif; font-size: 11px; font-weight: 600; padding: 8px; background: #f0f0f0; border-radius: 4px;">üìã View Raw Parsed Data</summary>';
      html += '<pre style="margin: 8px 0 0 0; padding: 12px; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">';
      html += escapeHtml(JSON.stringify(guidelines, null, 2));
      html += '</pre></details>';
      
      preview.innerHTML = html;
      section.style.display = 'block';
    }

    // ========== ANALYZE SELECTION ==========
    function analyzeSelection() {
      if (!parsedGuidelines) {
        showMessage('Please upload and parse brand guidelines first', 'error');
        return;
      }
      
      const btn = document.getElementById('analyze-button');
      btn.disabled = true;
      btn.innerHTML = 'üîç Analyzing... <span class="loading-spinner"></span>';
      
      parent.postMessage({ 
        pluginMessage: { type: 'analyze-selection' } 
      }, '*');
    }

    // ========== COMPLIANCE GRADE ==========
    async function generateComplianceGrade() {
      if (!parsedGuidelines) {
        showMessage('Please upload and parse brand guidelines first', 'error');
        return;
      }

      const btn = document.getElementById('grade-button');
      btn.disabled = true;
      btn.innerHTML = 'üì∏ Capturing frame... <span class="loading-spinner"></span>';

      try {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'capture-grade-data'
          } 
        }, '*');
        
        await new Promise(resolve => setTimeout(resolve, 2000));

        if (!gradeFrameData) {
          showMessage('Failed to capture frame data. Make sure a frame is selected.', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üéØ Grade Selected Frame';
          return;
        }

        const apiKeyInput = document.getElementById('api-key-input');
        const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

        if (!apiKey) {
          showMessage('API key required for compliance grading', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üéØ Grade Selected Frame';
          return;
        }

        const endpoint = document.getElementById('api-endpoint-input').value.trim();
        if (!endpoint || endpoint.includes('YOUR-API-URL')) {
          showMessage('Backend API URL is required', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üéØ Grade Selected Frame';
          return;
        }

        // Clean endpoint
        let cleanEndpoint = endpoint;
        if (!cleanEndpoint.startsWith('http://') && !cleanEndpoint.startsWith('https://')) {
          cleanEndpoint = 'https://' + cleanEndpoint;
        }
        if (cleanEndpoint.endsWith('/')) {
          cleanEndpoint = cleanEndpoint.slice(0, -1);
        }

        btn.innerHTML = 'ü§ñ Analyzing against guidelines... <span class="loading-spinner"></span>';

        // Send to Figma plugin to make the API call
        parent.postMessage({ 
          pluginMessage: { 
            type: 'grade-frame',
            frameData: gradeFrameData,
            guidelinesContent: parsedGuidelines.rawContent || '',
            aiUnderstanding: parsedGuidelines.aiUnderstanding || {},
            colors: parsedGuidelines.colors || [],
            typography: parsedGuidelines.typography || {},
            spacing: parsedGuidelines.spacing || {},
            apiKey: apiKey,
            endpoint: cleanEndpoint,
            pdfBase64: null  // INCLUDE PDF
          } 
        }, '*');

      } catch (error) {
        console.error('Grade error:', error);
        showMessage('Error: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üéØ Grade Selected Frame';
      }
    }

    // ========== DISPLAY COMPLIANCE GRADE ==========
    function displayComplianceGrade(report, frameData) {
      const resultsDiv = document.getElementById('grade-results');
      
      const totalChecks = (report.violations || []).length + (report.passed || []).length + (report.warnings || []).length;
      const passedCount = (report.passed || []).length;
      const warningCount = (report.warnings || []).length;
      const criticalCount = (report.violations || []).length;

      document.getElementById('stat-pass').textContent = passedCount;
      document.getElementById('stat-warning').textContent = warningCount;
      document.getElementById('stat-critical').textContent = criticalCount;

      if (frameData.screenshot) {
        const previewImg = document.getElementById('preview-image');
        previewImg.src = frameData.screenshot;
        previewImg.style.display = 'block';
      }
      document.getElementById('preview-name').textContent = frameData.frameName || 'Selected Frame';

      const elementsHtml = [];
      if (frameData.colors && frameData.colors.length > 0) {
        elementsHtml.push(`üé® ${frameData.colors.length} colors`);
      }
      if (frameData.fonts && frameData.fonts.length > 0) {
        elementsHtml.push(`‚úçÔ∏è ${frameData.fonts.length} fonts`);
      }
      if (frameData.images && frameData.images.length > 0) {
        elementsHtml.push(`üì∏ ${frameData.images.length} images`);
      }
      document.getElementById('detected-elements').innerHTML = elementsHtml.join(' ‚Ä¢ ');

      let colorsHtml = '';
      if (frameData.colors && frameData.colors.length > 0) {
        frameData.colors.slice(0, 8).forEach(color => {
          colorsHtml += `<div style="text-align: center;">
            <div class="color-swatch" style="background: ${color.hex}; width: 28px; height: 28px; border-radius: 4px; border: 1px solid #ddd;"></div>
            <div style="font-size: 8px; color: #999; margin-top: 2px;">${color.hex}</div>
          </div>`;
        });
      }
      document.getElementById('colors-list').innerHTML = colorsHtml || '<div style="color: #999; font-size: 10px;">No colors detected</div>';

      let fontsHtml = '';
      if (frameData.fonts && frameData.fonts.length > 0) {
        frameData.fonts.forEach(font => {
          fontsHtml += `<span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">${font}</span>`;
        });
      }
      document.getElementById('fonts-list').innerHTML = fontsHtml || '<div style="color: #999; font-size: 10px;">No fonts detected</div>';

      const byCategory = {};
      
      [...(report.passed || []), ...(report.warnings || []), ...(report.violations || [])].forEach(item => {
        const cat = item.category || 'Other';
        if (!byCategory[cat]) {
          byCategory[cat] = { critical: [], warning: [], pass: [] };
        }
        
        if (item.severity === 'critical') {
          byCategory[cat].critical.push(item);
        } else if (item.severity === 'warning') {
          byCategory[cat].warning.push(item);
        } else {
          byCategory[cat].pass.push(item);
        }
      });

      let categoriesHtml = '';
      Object.entries(byCategory).forEach(([category, items]) => {
        const hasCritical = items.critical.length > 0;
        const hasWarning = items.warning.length > 0;
        const categoryClass = hasCritical ? 'red' : hasWarning ? 'yellow' : 'green';
        const statusIcon = hasCritical ? '‚úó' : hasWarning ? '‚ö†' : '‚úì';
        const totalIssues = items.critical.length + items.warning.length + items.pass.length;
        const resolvedIssues = items.pass.length;

        categoriesHtml += `
          <div class="grade-category ${categoryClass}">
            <div class="grade-category-header" onclick="this.nextElementSibling.classList.toggle('active')">
              <span class="grade-status-icon">${statusIcon}</span>
              <span class="grade-category-title">${category}</span>
              <span class="grade-category-count">${resolvedIssues}/${totalIssues}</span>
            </div>
            <div class="grade-category-content active">`;

        if (items.critical.length === 0 && items.warning.length === 0 && items.pass.length > 0) {
          categoriesHtml += `<div class="no-issues">‚úì All checks passed</div>`;
        } else {
          items.pass.forEach(item => {
            categoriesHtml += `
              <div class="grade-violation-item pass">
                <div class="grade-violation-title">‚úì ${item.check}</div>
                <div class="grade-violation-reason">${item.reason}</div>
              </div>`;
          });

          items.warning.forEach(item => {
            categoriesHtml += `
              <div class="grade-violation-item warning">
                <div class="grade-violation-title">‚ö† ${item.check}</div>
                <div class="grade-violation-reason">${item.reason}</div>
              </div>`;
          });

          items.critical.forEach(item => {
            categoriesHtml += `
              <div class="grade-violation-item critical">
                <div class="grade-violation-title">‚úó ${item.check}</div>
                <div class="grade-violation-reason">${item.reason}</div>
              </div>`;
          });
        }

        categoriesHtml += '</div></div>';
      });

      document.getElementById('violations-container').innerHTML = categoriesHtml;
      resultsDiv.style.display = 'block';
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // ========== DISPLAY ANALYSIS (OLD FALLBACK) ==========
    function displayAnalysis(analysis) {
      const container = document.getElementById('analysis-results');
      
      let html = '<div class="analysis-result">';
      
      if (analysis.selectionCount && analysis.selectionCount > 1) {
        html += `<div class="section">
          <h3>Section Analysis <span class="stat-badge">${analysis.selectionCount} elements</span></h3>
          <p style="color: #666; font-size: 11px;">Analyzing ${analysis.selectionCount} selected elements</p>
        </div>`;
      } else {
        html += `<div class="section">
          <h3>Analysis: ${escapeHtml(analysis.name)}</h3>
          <p style="color: #666; font-size: 11px;">Element type: ${analysis.elementType}</p>
        </div>`;
      }

      if (analysis.violations && analysis.violations.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚ö†Ô∏è Issues Found <span class="stat-badge" style="background: #dc3545;">' + analysis.violations.length + '</span></h4>';
        html += '<ul class="violations-list">';
        analysis.violations.forEach(v => {
          html += `<li class="${v.severity}">
            ${escapeHtml(v.message)}
            <span class="severity-badge severity-${v.severity}">${v.severity}</span>
          </li>`;
        });
        html += '</ul></div>';
      }

      if (analysis.goodPractices && analysis.goodPractices.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚úÖ What\'s Working Well <span class="stat-badge" style="background: #28a745;">' + analysis.goodPractices.length + '</span></h4>';
        html += '<ul class="good-list">';
        analysis.goodPractices.forEach(g => {
          html += `<li>${escapeHtml(g)}</li>`;
        });
        html += '</ul></div>';
      }

      if (analysis.suggestions && analysis.suggestions.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>üí° Suggestions</h4>';
        html += '<ul class="suggestions-list">';
        analysis.suggestions.forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
      }

      html += '</div>';
      container.innerHTML = html;
      
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ========== CHAT FUNCTIONS ==========
    function enableChat() {
      const welcome = document.getElementById('chat-welcome');
      if (welcome) {
        welcome.remove();
      }
      
      const apiKeyInput = document.getElementById('api-key-input');
      const hasApiKey = apiKeyInput && apiKeyInput.value.trim().length > 0;
      
      document.getElementById('chat-input').disabled = false;
      document.getElementById('send-chat-btn').disabled = false;
      
      const statusBadge = document.getElementById('chat-status-badge');
      
      if (hasApiKey) {
        document.getElementById('chat-status-text').innerHTML = '‚úÖ AI Brand Assistant is ready! Ask me anything about your brand guidelines or designs.';
        statusBadge.style.background = '#d4edda';
        statusBadge.style.color = '#155724';
        statusBadge.textContent = '‚úì Ready';
        
        if (chatHistory.length === 0) {
          const brandName = parsedGuidelines.aiUnderstanding?.brandEssence || 'your brand';
          addChatMessage('ai', `Hi! üëã I've learned all about ${brandName}. I can help you understand your brand guidelines and answer any design questions. What would you like to know?`);
        }
      } else {
        document.getElementById('chat-status-text').innerHTML = '‚ö†Ô∏è Chat is enabled, but add your API key in "Upload Guidelines" tab for full functionality.';
        statusBadge.style.background = '#fff3cd';
        statusBadge.style.color = '#856404';
        statusBadge.textContent = '‚ö†Ô∏è API Key Needed';
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Check if guidelines are loaded
      if (!parsedGuidelines) {
        console.log('‚ùå No guidelines loaded');
        addChatMessage('system', 'Please upload brand guidelines with AI analysis enabled first (in the Upload Guidelines tab).');
        return;
      }
      
      const apiKeyInput = document.getElementById('api-key-input');
      const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
      
      if (!apiKey) {
        input.value = '';
        addChatMessage('user', message);
        addChatMessage('system', 'üîë To use AI chat, please add your Anthropic API key in the "Upload Guidelines" tab.');
        input.value = message;
        return;
      }
      
      addChatMessage('user', message);
      input.value = '';
      
      const loadingId = 'loading-' + Date.now();
      addChatMessage('ai', '‚è≥ Thinking...', loadingId);
      
      try {
        // NEW: Pass PDF data to chat function
        const response = await chatWithAI(message, apiKey, uploadedPDFBase64, uploadedPDFName);
        
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        addChatMessage('ai', response);
      } catch (error) {
        console.error('Chat error:', error);
        
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        if (error.message.includes('401') || error.message.includes('authentication')) {
          addChatMessage('system', '‚ùå Invalid API key. Please check your Anthropic API key in the Upload Guidelines tab.');
        } else {
          addChatMessage('system', '‚ùå Error: ' + error.message);
        }
      }
    }

    function addChatMessage(type, message, id) {
      const container = document.getElementById('chat-messages');
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message ' + type;
      msgDiv.style.padding = '12px';
      msgDiv.style.marginBottom = '8px';
      msgDiv.style.borderRadius = '6px';
      msgDiv.style.fontSize = '11px';
      msgDiv.style.lineHeight = '1.6';
      
      if (type === 'user') {
        msgDiv.style.background = '#667eea';
        msgDiv.style.color = 'white';
        msgDiv.style.marginLeft = '20px';
        msgDiv.style.textAlign = 'right';
      } else if (type === 'ai') {
        msgDiv.style.background = '#f0f2ff';
        msgDiv.style.color = '#333';
        msgDiv.style.marginRight = '20px';
      } else {
        msgDiv.style.background = '#fff3cd';
        msgDiv.style.color = '#856404';
      }
      
      if (id) msgDiv.id = id;
      msgDiv.textContent = message;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
      
      if (type !== 'system') {
        chatHistory.push({ 
          role: type === 'user' ? 'user' : 'assistant', 
          content: message 
        });
      }
    }

    // ========== CHAT WITH AI (CALLS PLUGIN, NOT API DIRECTLY) ==========
    async function chatWithAI(userMessage, apiKey, pdfBase64, pdfName) {
      let endpoint = document.getElementById('api-endpoint-input').value.trim();
      
      if (!endpoint || endpoint === 'https://your-backend.vercel.app' || endpoint.includes('YOUR-API-URL')) {
        throw new Error('API endpoint URL is required.');
      }
      
      if (!endpoint.startsWith('http://') && !endpoint.startsWith('https://')) {
        endpoint = 'https://' + endpoint;
      }
      
      endpoint = endpoint.replace(/\/$/, '');

      // Build a shorter context prompt
      let contextPrompt = `You are an expert brand design consultant helping with brand guidelines.

User's Question: ${userMessage}

Answer based on the uploaded brand guidelines document. Be specific and reference the guidelines.`;

      const messages = chatHistory.slice(-6).map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      messages.push({
        role: 'user',
        content: contextPrompt
      });

      console.log('üí¨ Sending chat request to PLUGIN (bypasses CORS)');
      console.log('üìÑ PDF:', pdfName, 'Size:', pdfBase64 ? Math.round(pdfBase64.length / 1024) + 'KB' : 'N/A');

      // Send to PLUGIN, not directly to API (bypasses CORS)
      return new Promise((resolve, reject) => {
        // Set up listener for response
        const messageHandler = (event) => {
          const msg = event.data.pluginMessage;
          if (msg.type === 'chat-response') {
            window.removeEventListener('message', messageHandler);
            resolve(msg.response);
          } else if (msg.type === 'chat-error') {
            window.removeEventListener('message', messageHandler);
            reject(new Error(msg.error));
          }
        };
        
        window.addEventListener('message', messageHandler);
        
        // Send request to plugin
        parent.postMessage({
          pluginMessage: {
            type: 'chat-with-pdf',
            messages: messages,
            apiKey: apiKey,
            pdfBase64: pdfBase64,
            pdfName: pdfName,
            endpoint: endpoint
          }
        }, '*');
        
        // Timeout after 30 seconds
        setTimeout(() => {
          window.removeEventListener('message', messageHandler);
          reject(new Error('Chat request timed out'));
        }, 30000);
      });
    }

    // ========== UTILITY FUNCTIONS ==========
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type !== 'info') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>