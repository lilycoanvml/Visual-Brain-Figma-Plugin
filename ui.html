<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      padding: 16px; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      font-size: 12px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: -16px -16px 16px -16px;
      padding: 20px 16px;
      color: white;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .header p {
      margin: 4px 0 0 0;
      font-size: 11px;
      opacity: 0.9;
    }
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      position: relative;
      transition: color 0.2s;
    }
    .tab.active {
      color: #667eea;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #667eea;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h3 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .button {
      width: 100%;
      padding: 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .button:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    .button:active {
      transform: translateY(0);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 11px;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      display: none;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border-left: 3px solid #28a745;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 3px solid #dc3545;
    }
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 3px solid #17a2b8;
    }
    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .file-upload:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .file-upload.dragover {
      border-color: #667eea;
      background: #f0f2ff;
      border-style: solid;
    }
    .file-upload-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    .file-upload-text {
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }
    .file-upload-subtext {
      font-size: 11px;
      color: #999;
    }
    .uploaded-file {
      background: #f0f2ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .uploaded-file-icon {
      font-size: 24px;
    }
    .uploaded-file-info {
      flex: 1;
    }
    .uploaded-file-name {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }
    .uploaded-file-size {
      font-size: 10px;
      color: #666;
    }
    .uploaded-file-remove {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }
    .analysis-result {
      margin-top: 16px;
    }
    .analysis-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .analysis-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .violations-list, .good-list, .suggestions-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .violations-list li, .good-list li, .suggestions-list li {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.5;
    }
    .violations-list li {
      background: #fff3cd;
      border-left: 3px solid #ffc107;
    }
    .violations-list li.high {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    .good-list li {
      background: #d4edda;
      border-left: 3px solid #28a745;
    }
    .suggestions-list li {
      background: #d1ecf1;
      border-left: 3px solid #17a2b8;
    }
    .severity-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 6px;
    }
    .severity-high {
      background: #dc3545;
      color: white;
    }
    .severity-medium {
      background: #ffc107;
      color: #000;
    }
    .severity-low {
      background: #17a2b8;
      color: white;
    }
    .guidelines-preview {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .guidelines-preview h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #333;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #file-input {
      display: none;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }
    .checkbox-group {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #333;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .checkbox-label:last-child {
      margin-bottom: 0;
    }
    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .stat-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® Brand Guidelines Checker</h1>
    <p>Upload guidelines and analyze Figma selections</p>
  </div>

  <div id="message"></div>

  <div class="tab-container">
    <button class="tab active" data-tab="upload">Upload Guidelines</button>
    <button class="tab" data-tab="analyze">Analyze Selection</button>
  </div>

  <!-- Upload Tab -->
  <div id="upload-tab" class="tab-content active">
    <div class="section">
      <h3>Upload Brand Guidelines Document</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Upload a TXT or PDF file containing your brand guidelines. The plugin will parse colors, fonts, spacing, images, and layouts.
      </p>

      <input type="file" id="file-input" accept=".txt,.pdf">
      
      <div class="file-upload" id="drop-zone">
        <div class="file-upload-icon">üìÅ</div>
        <div class="file-upload-text">Drop your guidelines here</div>
        <div class="file-upload-subtext">Supports TXT and PDF (max 50MB)</div>
      </div>

      <div id="uploaded-file-display"></div>

      <div class="checkbox-group" id="parse-options">
        <label class="checkbox-label">
          <input type="checkbox" id="deep-analysis" checked>
          <span>üîç Deep Analysis (Extract images, colors from PDF pages)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ocr-analysis">
          <span>üì∑ OCR Analysis (Extract text from images - slower)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="ai-analysis" checked>
          <span>ü§ñ AI Analysis (Understand brand voice, tone, and visual style)</span>
        </label>
      </div>

      <div id="api-endpoint-section" style="margin-top: 12px;">
        <label style="display: block; font-size: 11px; font-weight: 500; color: #666; margin-bottom: 4px;">
          Backend API URL (Required)
        </label>
        <input type="text" id="api-endpoint-input" placeholder="https://your-backend.vercel.app" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
        <p style="font-size: 9px; color: #999; margin: 4px 0 0 0;">
          Enter your backend API endpoint (e.g., https://my-app.vercel.app)
        </p>
      </div>

      <div id="api-key-section" style="margin-top: 12px;">
        <label style="display: block; font-size: 11px; font-weight: 500; color: #666; margin-bottom: 4px;">
          Anthropic API Key (Required for AI features)
        </label>
        <input type="password" id="api-key-input" placeholder="sk-ant-..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
        <p style="font-size: 9px; color: #999; margin: 4px 0 0 0;">
          Get your API key at <a href="https://console.anthropic.com" target="_blank" style="color: #667eea;">console.anthropic.com</a>
        </p>
      </div>

      <div id="parse-progress" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">Processing...</div>
      </div>

      <button class="button" id="parse-button" disabled>
        üîç Parse Guidelines
      </button>
    </div>

    <div id="guidelines-preview-section" style="display: none;">
      <div class="section">
        <h3>Parsed Guidelines</h3>
        <div class="guidelines-preview" id="guidelines-preview-content"></div>
      </div>
    </div>
  </div>

  <!-- Analyze Tab -->
  <div id="analyze-tab" class="tab-content">
    <div class="section" id="ai-chat-section">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <h3 style="margin: 0;">üí¨ AI Brand Assistant</h3>
        <div id="chat-status-badge" style="padding: 4px 12px; background: #e0e0e0; color: #666; border-radius: 12px; font-size: 10px; font-weight: 600;">
          ‚è≥ Waiting for guidelines...
        </div>
      </div>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        <span id="chat-status-text">‚ö†Ô∏è AI chat is currently unavailable in Figma plugins due to CORS restrictions. Use the pattern-based analysis features below!</span>
      </p>
      
      <div id="chat-messages" style="background: #f8f9fa; border-radius: 8px; padding: 12px; min-height: 250px; max-height: 400px; overflow-y: auto; margin-bottom: 12px;">
        <div id="chat-welcome" style="text-align: center; color: #999; font-size: 11px; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 12px;">ü§ñ</div>
          <p style="margin: 0 0 8px 0;"><strong>AI Brand Assistant Ready</strong></p>
          <p style="margin: 0;">Upload your brand guidelines with AI analysis enabled, then come back here to:</p>
          <ul style="list-style: none; padding: 0; margin: 12px 0 0 0;">
            <li>‚úÖ Validate your guidelines</li>
            <li>üí° Get improvement suggestions</li>
            <li>üé® Explore design ideas</li>
            <li>üéØ Understand your brand better</li>
            <li>üìê Check Figma designs</li>
          </ul>
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <input 
          type="text" 
          id="chat-input" 
          placeholder="Ask about your brand, guidelines, or get design feedback..."
          style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 12px; transition: border-color 0.2s;"
          onkeypress="if(event.key === 'Enter') sendChatMessage()"
          onfocus="this.style.borderColor='#667eea'"
          onblur="this.style.borderColor='#ddd'"
          disabled
        >
        <button class="button" onclick="sendChatMessage()" id="send-chat-btn" style="width: auto; padding: 10px 20px;" disabled>
          Send
        </button>
      </div>

      <div id="quick-questions" style="margin-bottom: 16px; display: none;">
        <p style="font-size: 10px; color: #666; margin: 0 0 6px 0; font-weight: 500;">Quick questions:</p>
        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
          <button class="button secondary" onclick="askQuickQuestion('Summarize my brand guidelines')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üìã Summarize guidelines
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What is my brand personality and target audience?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üéØ Brand overview
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What colors and fonts should I use?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üé® Design specs
          </button>
          <button class="button secondary" onclick="askQuickQuestion('Give me 3 design ideas that match my brand')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            üí° Design ideas
          </button>
          <button class="button secondary" onclick="askQuickQuestion('What are the dos and donts of my brand?')" style="width: auto; padding: 6px 12px; font-size: 10px;">
            ‚ö†Ô∏è Dos & Don'ts
          </button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>üîç Analyze Figma Selection</h3>
      <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
        Select elements in Figma to check them against your brand guidelines.
      </p>
      <button class="button" id="analyze-button">üîç Analyze Selected Elements</button>
      <p style="font-size: 10px; color: #999; margin-top: 8px; text-align: center;">
        Tip: Select multiple elements for a section overview
      </p>
    </div>

    <div id="analysis-results"></div>
  </div>

  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    let uploadedFile = null;
    let uploadedFileContent = null;
    let parsedGuidelines = null;
    let pdfImages = [];
    let chatHistory = [];
    let currentAnalysisData = null;

    window.onload = () => {
      setupDragAndDrop();
      setupTabs();
      setupButtons();
      setupAPIKeySection();
      parent.postMessage({ pluginMessage: { type: 'load-guidelines' } }, '*');
    };

    function setupAPIKeySection() {
      const aiCheckbox = document.getElementById('ai-analysis');
      const apiKeySection = document.getElementById('api-key-section');
      const apiEndpointSection = document.getElementById('api-endpoint-section');
      
      aiCheckbox.addEventListener('change', (e) => {
        apiKeySection.style.display = e.target.checked ? 'block' : 'none';
        apiEndpointSection.style.display = e.target.checked ? 'block' : 'none';
      });
      
      parent.postMessage({ pluginMessage: { type: 'load-api-key' } }, '*');
      parent.postMessage({ pluginMessage: { type: 'load-api-endpoint' } }, '*');
      
      if (aiCheckbox.checked) {
        apiKeySection.style.display = 'block';
        apiEndpointSection.style.display = 'block';
      }
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === 'guidelines-loaded') {
        if (msg.guidelines) {
          parsedGuidelines = msg.guidelines;
          displayGuidelinesPreview(msg.guidelines);
          if (msg.guidelines.aiUnderstanding) {
            enableChat();
          }
        }
      }
      
      if (msg.type === 'api-key-loaded') {
        if (msg.apiKey) {
          document.getElementById('api-key-input').value = msg.apiKey;
        }
      }

      if (msg.type === 'api-endpoint-loaded') {
        if (msg.endpoint) {
          document.getElementById('api-endpoint-input').value = msg.endpoint;
        }
      }
      
      if (msg.type === 'parse-success') {
        parsedGuidelines = msg.guidelines;
        displayGuidelinesPreview(msg.guidelines);
        showMessage('Guidelines parsed and saved successfully!', 'success');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        
        if (msg.guidelines.aiUnderstanding) {
          enableChat();
          showMessage('AI Brand Assistant is now ready! Go to the Analyze tab to chat.', 'success');
        }
      }
      
      if (msg.type === 'analysis-complete') {
        currentAnalysisData = msg.analysis;
        displayAnalysis(msg.analysis);
        
        if (parsedGuidelines && parsedGuidelines.aiUnderstanding) {
          const summary = `üìä Analysis complete for "${msg.analysis.name}". Found ${msg.analysis.violations.length} issues and ${msg.analysis.goodPractices.length} good practices. Feel free to ask me about the results!`;
          addChatMessage('system', summary);
        }
      }
      
      if (msg.type === 'error') {
        showMessage(msg.message, 'error');
        hideProgress();
        const btn = document.getElementById('parse-button');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
      }
    };

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    function setupButtons() {
      document.getElementById('parse-button').addEventListener('click', parseGuidelines);
      document.getElementById('analyze-button').addEventListener('click', analyzeSelection);
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('drop-zone').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
    }

    function setupDragAndDrop() {
      const dropZone = document.getElementById('drop-zone');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('dragover');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('dragover');
        }, false);
      });

      dropZone.addEventListener('drop', handleDrop, false);
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    async function handleFile(file) {
      const maxSize = 50 * 1024 * 1024;
      const allowedTypes = ['.txt', '.pdf'];
      const fileExt = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedTypes.includes(fileExt)) {
        showMessage('Invalid file type. Please upload TXT or PDF files.', 'error');
        return;
      }

      if (file.size > maxSize) {
        showMessage('File is too large. Maximum size is 50MB.', 'error');
        return;
      }

      uploadedFile = file;
      showMessage('Processing file...', 'info');

      try {
        if (fileExt === '.pdf') {
          uploadedFileContent = await extractTextFromPDF(file);
          if (!uploadedFileContent || uploadedFileContent.trim().length === 0) {
            showMessage('Could not extract text from PDF. The PDF might be image-based or empty.', 'error');
            uploadedFile = null;
            uploadedFileContent = null;
            return;
          }
        } else {
          uploadedFileContent = await readTextFile(file);
        }

        displayUploadedFile(file);
        document.getElementById('parse-button').disabled = false;
        showMessage('File loaded successfully! Click "Parse Guidelines" to extract brand rules.', 'success');
      } catch (error) {
        console.error('File handling error:', error);
        showMessage('Error reading file: ' + error.message, 'error');
        uploadedFile = null;
        uploadedFileContent = null;
      }
    }

    function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    async function extractTextFromPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        let fullText = '';
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        
        return fullText;
      } catch (error) {
        console.error('PDF extraction error:', error);
        throw new Error('Failed to extract text from PDF');
      }
    }

    async function extractImagesAndColorsFromPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        const extractedColors = new Set();
        const images = [];
        
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          updateProgress((pageNum / pdf.numPages) * 100, `Analyzing page ${pageNum} of ${pdf.numPages}...`);
          
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1.0 });
          
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
          
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const pixels = imageData.data;
          
          for (let i = 0; i < pixels.length; i += 200) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            const a = pixels[i + 3];
            
            if (a > 200 && !(r > 240 && g > 240 && b > 240) && !(r < 15 && g < 15 && b < 15)) {
              const hex = rgbToHex(r, g, b);
              extractedColors.add(hex);
            }
          }
          
          images.push(canvas.toDataURL('image/png'));
        }
        
        return {
          colors: Array.from(extractedColors),
          images: images
        };
      } catch (error) {
        console.error('Image extraction error:', error);
        throw new Error('Failed to extract images from PDF');
      }
    }

    async function performOCR(images) {
      if (typeof Tesseract === 'undefined') {
        console.warn('Tesseract.js not loaded, skipping OCR');
        return '';
      }

      let ocrText = '';
      
      for (let i = 0; i < images.length; i++) {
        updateProgress(((i + 1) / images.length) * 100, `Running OCR on page ${i + 1} of ${images.length}...`);
        
        try {
          const result = await Tesseract.recognize(images[i], 'eng');
          ocrText += result.data.text + '\n';
        } catch (error) {
          console.error('OCR error on page', i + 1, error);
        }
      }
      
      return ocrText;
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => {
        const hex = Math.round(x).toString(16).toUpperCase();
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    function displayUploadedFile(file) {
      const container = document.getElementById('uploaded-file-display');
      const sizeKB = (file.size / 1024).toFixed(2);
      
      container.innerHTML = `
        <div class="uploaded-file">
          <div class="uploaded-file-icon">üìÑ</div>
          <div class="uploaded-file-info">
            <div class="uploaded-file-name">${escapeHtml(file.name)}</div>
            <div class="uploaded-file-size">${sizeKB} KB</div>
          </div>
          <button class="uploaded-file-remove" onclick="removeFile()" title="Remove file">√ó</button>
        </div>
      `;
    }

    function removeFile() {
      uploadedFile = null;
      uploadedFileContent = null;
      pdfImages = [];
      document.getElementById('uploaded-file-display').innerHTML = '';
      document.getElementById('file-input').value = '';
      document.getElementById('parse-button').disabled = true;
      document.getElementById('guidelines-preview-section').style.display = 'none';
    }

    function updateProgress(percent, text) {
      document.getElementById('parse-progress').style.display = 'block';
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('progress-text').textContent = text;
    }

    function hideProgress() {
      document.getElementById('parse-progress').style.display = 'none';
      document.getElementById('progress-fill').style.width = '0%';
    }

    async function parseGuidelines() {
      if (!uploadedFileContent) {
        showMessage('Please upload a file first.', 'error');
        return;
      }

      if (!uploadedFileContent.trim()) {
        showMessage('The file appears to be empty.', 'error');
        return;
      }

      const btn = document.getElementById('parse-button');
      btn.disabled = true;
      btn.innerHTML = 'üîç Parsing... <span class="loading-spinner"></span>';

      const deepAnalysis = document.getElementById('deep-analysis').checked;
      const ocrAnalysis = document.getElementById('ocr-analysis').checked;
      const aiAnalysis = document.getElementById('ai-analysis').checked;
      
      let content = uploadedFileContent;
      let extractedColors = [];
      let aiUnderstanding = null;
      
      try {
        if (uploadedFile.name.endsWith('.pdf')) {
          if (deepAnalysis) {
            updateProgress(10, 'Extracting images and colors from PDF...');
            const extracted = await extractImagesAndColorsFromPDF(uploadedFile);
            extractedColors = extracted.colors;
            pdfImages = extracted.images;
            
            if (ocrAnalysis && pdfImages.length > 0) {
              updateProgress(30, 'Running OCR analysis...');
              const ocrText = await performOCR(pdfImages);
              content += '\n\n' + ocrText;
            }
          }
        }
        
        if (aiAnalysis) {
          const apiKey = document.getElementById('api-key-input').value.trim();
          if (apiKey) {
            parent.postMessage({ 
              pluginMessage: { 
                type: 'save-api-key',
                apiKey: apiKey
              } 
            }, '*');
            
            updateProgress(60, 'AI is reading and understanding your brand guidelines...');
            
            try {
              aiUnderstanding = await analyzeWithAI(content, pdfImages.slice(0, 3), apiKey);
            } catch (error) {
              console.error('AI analysis error:', error);
              showMessage('AI analysis failed: ' + error.message + '. Continuing with standard analysis...', 'error');
            }
          } else {
            showMessage('AI analysis requires an API key. Continuing with standard analysis...', 'info');
          }
        }
        
        updateProgress(90, 'Parsing guidelines...');
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'parse-guidelines',
            content: content,
            filename: uploadedFile.name,
            extractedColors: extractedColors,
            aiUnderstanding: aiUnderstanding
          } 
        }, '*');
      } catch (error) {
        console.error('Parse error:', error);
        showMessage('Error during analysis: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîç Parse Guidelines';
        hideProgress();
      }
    }

    async function analyzeWithAI(content, imageDataUrls, apiKey) {
      let endpoint = document.getElementById('api-endpoint-input').value.trim();
      
      if (!endpoint || endpoint === 'https://your-backend.vercel.app' || endpoint.includes('YOUR-API-URL')) {
        throw new Error('API endpoint URL is required. Please enter your backend API URL in the "Backend API URL" field.');
      }
      
      if (!endpoint.startsWith('http://') && !endpoint.startsWith('https://')) {
        endpoint = 'https://' + endpoint;
      }
      
      endpoint = endpoint.replace(/\/$/, '');
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-api-endpoint',
          endpoint: endpoint
        } 
      }, '*');

      const response = await fetch(`${endpoint}/api/analyze-guidelines`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          content: content,
          images: imageDataUrls,
          apiKey: apiKey
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'API request failed');
      }

      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Analysis failed');
      }

      return data.data;
    }

    function displayGuidelinesPreview(guidelines) {
      const preview = document.getElementById('guidelines-preview-content');
      const section = document.getElementById('guidelines-preview-section');
      
      let html = '';
      
      if (guidelines.aiUnderstanding) {
        const ai = guidelines.aiUnderstanding;
        
        html += '<div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">';
        html += '<h4 style="margin: 0 0 12px 0; font-family: Inter, sans-serif; font-size: 14px;">ü§ñ AI Brand Understanding</h4>';
        
        if (ai.brandEssence) {
          html += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; margin-bottom: 12px; font-style: italic; font-size: 12px; line-height: 1.6;">';
          html += '"' + escapeHtml(ai.brandEssence) + '"';
          html += '</div>';
        }
        
        if (ai.brandPersonality) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Brand Personality:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.brandPersonality) + '</p>';
          html += '</div>';
        }
        
        if (ai.visualStyle) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Visual Style:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.visualStyle) + '</p>';
          html += '</div>';
        }
        
        if (ai.targetAudience) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">Target Audience:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.targetAudience) + '</p>';
          html += '</div>';
        }
        
        if (ai.colorPsychology) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">üé® Color Psychology:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.colorPsychology) + '</p>';
          html += '</div>';
        }
        
        if (ai.imageryStyle) {
          html += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px;">';
          html += '<strong style="display: block; margin-bottom: 4px; font-size: 11px; opacity: 0.9;">üì∏ Imagery Style:</strong>';
          html += '<p style="margin: 0; font-size: 11px; line-height: 1.5;">' + escapeHtml(ai.imageryStyle) + '</p>';
          html += '</div>';
        }
        
        html += '</div>';
      }
      
      html += '<details style="font-family: Courier New, monospace; font-size: 10px; line-height: 1.4;">';
      html += '<summary style="cursor: pointer; font-family: Inter, sans-serif; font-size: 11px; font-weight: 600; padding: 8px; background: #f0f0f0; border-radius: 4px;">üìã View Raw Parsed Data</summary>';
      html += '<pre style="margin: 8px 0 0 0; padding: 12px; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">';
      html += escapeHtml(JSON.stringify(guidelines, null, 2));
      html += '</pre></details>';
      
      preview.innerHTML = html;
      section.style.display = 'block';
    }

    function analyzeSelection() {
      parent.postMessage({ 
        pluginMessage: { type: 'analyze-selection' } 
      }, '*');
    }

    function enableChat() {
      const welcome = document.getElementById('chat-welcome');
      if (welcome) {
        welcome.remove();
      }
      
      const apiKeyInput = document.getElementById('api-key-input');
      const hasApiKey = apiKeyInput && apiKeyInput.value.trim().length > 0;
      
      document.getElementById('chat-input').disabled = false;
      document.getElementById('send-chat-btn').disabled = false;
      
      const statusBadge = document.getElementById('chat-status-badge');
      
      if (hasApiKey) {
        document.getElementById('chat-status-text').innerHTML = '‚úÖ AI Brand Assistant is ready! Ask me anything about your brand guidelines or designs.';
        statusBadge.style.background = '#d4edda';
        statusBadge.style.color = '#155724';
        statusBadge.textContent = '‚úì Ready';
        
        if (chatHistory.length === 0) {
          const brandName = parsedGuidelines.aiUnderstanding?.brandEssence || 'your brand';
          addChatMessage('ai', `Hi! üëã I've learned all about ${brandName}. I can help you:\n\n‚Ä¢ Understand your brand guidelines\n‚Ä¢ Validate design decisions\n‚Ä¢ Explore creative ideas\n‚Ä¢ Check Figma designs for compliance\n‚Ä¢ Answer any brand-related questions\n\nWhat would you like to know?`);
        }
      } else {
        document.getElementById('chat-status-text').innerHTML = '‚ö†Ô∏è Chat is enabled, but add your API key in "Upload Guidelines" tab for full functionality.';
        statusBadge.style.background = '#fff3cd';
        statusBadge.style.color = '#856404';
        statusBadge.textContent = '‚ö†Ô∏è API Key Needed';
        
        if (chatHistory.length === 0) {
          const brandName = parsedGuidelines.aiUnderstanding?.brandEssence || 'your brand';
          addChatMessage('ai', `Hi! üëã I've learned all about ${brandName}.\n\n‚ö†Ô∏è To start chatting, please add your Anthropic API key in the "Upload Guidelines" tab.\n\nGet a free API key at: console.anthropic.com\n\nOnce added, come back and ask me anything!`);
        }
      }
      
      document.getElementById('quick-questions').style.display = 'block';
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!parsedGuidelines || !parsedGuidelines.aiUnderstanding) {
        addChatMessage('system', 'Please upload brand guidelines with AI analysis enabled first (in the Upload Guidelines tab).');
        return;
      }
      
      const apiKeyInput = document.getElementById('api-key-input');
      const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
      
      if (!apiKey) {
        input.value = '';
        addChatMessage('user', message);
        addChatMessage('system', 'üîë To use AI chat, please add your Anthropic API key:\n\n1. Go to the "Upload Guidelines" tab\n2. Scroll to the API key field\n3. Enter your key (get one free at console.anthropic.com)\n4. Come back here and ask again!\n\nYour message has been saved.');
        input.value = message;
        return;
      }
      
      addChatMessage('user', message);
      input.value = '';
      
      const loadingId = 'loading-' + Date.now();
      addChatMessage('ai', '<div style="display:flex;gap:4px;"><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s infinite;"></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s infinite;animation-delay:0.2s;"></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s infinite;animation-delay:0.4s;"></div></div><style>@keyframes bounce{0%,80%,100%{transform:translateY(0);}40%{transform:translateY(-10px);}}</style>', loadingId);
      
      try {
        const response = await chatWithAI(message, apiKey);
        
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        addChatMessage('ai', response);
      } catch (error) {
        console.error('Chat error:', error);
        
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        if (error.message.includes('401') || error.message.includes('authentication')) {
          addChatMessage('system', '‚ùå Invalid API key. Please check your Anthropic API key in the Upload Guidelines tab and try again.');
        } else {
          addChatMessage('system', '‚ùå Error: ' + error.message + '\n\nPlease try again or check your internet connection.');
        }
      }
    }

    function askQuickQuestion(question) {
      document.getElementById('chat-input').value = question;
      sendChatMessage();
    }

    function addChatMessage(type, message, id) {
      const container = document.getElementById('chat-messages');
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message ' + type;
      msgDiv.style.padding = '12px';
      msgDiv.style.marginBottom = '8px';
      msgDiv.style.borderRadius = '6px';
      msgDiv.style.fontSize = '11px';
      msgDiv.style.lineHeight = '1.6';
      
      if (type === 'user') {
        msgDiv.style.background = '#667eea';
        msgDiv.style.color = 'white';
        msgDiv.style.marginLeft = '20px';
        msgDiv.style.textAlign = 'right';
      } else if (type === 'ai') {
        msgDiv.style.background = '#f0f2ff';
        msgDiv.style.color = '#333';
        msgDiv.style.marginRight = '20px';
      } else {
        msgDiv.style.background = '#fff3cd';
        msgDiv.style.color = '#856404';
      }
      
      if (id) msgDiv.id = id;
      
      msgDiv.innerHTML = message;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
      
      if (type !== 'system' && !message.includes('animation:bounce')) {
        chatHistory.push({ 
          role: type === 'user' ? 'user' : 'assistant', 
          content: message 
        });
      }
    }

    async function chatWithAI(userMessage, apiKey) {
      let endpoint = document.getElementById('api-endpoint-input').value.trim();
      
      if (!endpoint || endpoint === 'https://your-backend.vercel.app' || endpoint.includes('YOUR-API-URL')) {
        throw new Error('API endpoint URL is required. Please enter your backend API URL in the "Backend API URL" field.');
      }
      
      if (!endpoint.startsWith('http://') && !endpoint.startsWith('https://')) {
        endpoint = 'https://' + endpoint;
      }
      
      endpoint = endpoint.replace(/\/$/, '');

      let contextPrompt = `You are an expert brand design consultant with deep understanding of the user's brand. You're having a conversation to help them understand and apply their brand guidelines.

BRAND GUIDELINES YOU'VE LEARNED:

Brand Essence: "${parsedGuidelines.aiUnderstanding.brandEssence}"

Brand Personality: ${parsedGuidelines.aiUnderstanding.brandPersonality}

Visual Style: ${parsedGuidelines.aiUnderstanding.visualStyle}

Target Audience: ${parsedGuidelines.aiUnderstanding.targetAudience}

Color Psychology: ${parsedGuidelines.aiUnderstanding.colorPsychology}

Imagery Style: ${parsedGuidelines.aiUnderstanding.imageryStyle}

User's question: ${userMessage}

Please provide helpful, specific advice that references the brand personality, values, and guidelines. Be conversational but professional. Give actionable recommendations when appropriate.`;

      const messages = chatHistory.slice(-10).map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      messages.push({
        role: 'user',
        content: contextPrompt
      });

      const response = await fetch(`${endpoint}/api/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messages: messages,
          apiKey: apiKey
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Chat request failed');
      }

      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Chat failed');
      }

      return data.data;
    }

    function displayAnalysis(analysis) {
      const container = document.getElementById('analysis-results');
      
      let html = '<div class="analysis-result">';
      
      if (analysis.selectionCount && analysis.selectionCount > 1) {
        html += `<div class="section">
          <h3>Section Analysis <span class="stat-badge">${analysis.selectionCount} elements</span></h3>
          <p style="color: #666; font-size: 11px;">Analyzing ${analysis.selectionCount} selected elements</p>
        </div>`;
      } else {
        html += `<div class="section">
          <h3>Analysis: ${escapeHtml(analysis.name)}</h3>
          <p style="color: #666; font-size: 11px;">Element type: ${analysis.elementType}</p>
        </div>`;
      }

      if (analysis.violations && analysis.violations.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚ö†Ô∏è Issues Found <span class="stat-badge" style="background: #dc3545;">' + analysis.violations.length + '</span></h4>';
        html += '<ul class="violations-list">';
        analysis.violations.forEach(v => {
          html += `<li class="${v.severity}">
            ${escapeHtml(v.message)}
            <span class="severity-badge severity-${v.severity}">${v.severity}</span>
          </li>`;
        });
        html += '</ul></div>';
      }

      if (analysis.goodPractices && analysis.goodPractices.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>‚úÖ What\'s Working Well <span class="stat-badge" style="background: #28a745;">' + analysis.goodPractices.length + '</span></h4>';
        html += '<ul class="good-list">';
        analysis.goodPractices.forEach(g => {
          html += `<li>${escapeHtml(g)}</li>`;
        });
        html += '</ul></div>';
      }

      if (analysis.suggestions && analysis.suggestions.length > 0) {
        html += '<div class="analysis-card">';
        html += '<h4>üí° Suggestions</h4>';
        html += '<ul class="suggestions-list">';
        analysis.suggestions.forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
      }

      html += '</div>';
      container.innerHTML = html;
      
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type !== 'info') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>